(()=>{function A(t){if(!t||typeof t!="string")return t;let e=t.trim();if(!e||/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e))return e;let a="http://localhost:8080";return e.startsWith("/api/")?`${a}${e}`:e.startsWith("api/")?`${a}/${e}`:e}window.resolveAssetUrl=A;window.toastConfig={default:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800},admin:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800,top:"16px",right:"16px",maxWidth:"320px",padding:"10px 14px",borderRadius:"8px",fontSize:"14px",lineHeight:"1.35"}};function B(t){let e=t?window.toastConfig.admin:window.toastConfig.default,a=window.toastOverrides&&typeof window.toastOverrides=="object"?window.toastOverrides:{};return{...e,...a}}var S="3";window.showToast=function(e,a="success"){let r=window.location.pathname.includes("/other/admin"),o=B(r),i=String(e??"").replace(/\s+/g," ").trim().slice(0,o.maxMessageLength),s=document.createElement("div");s.className=`toast-notification ${a}`,s.textContent=i||"\u0413\u043E\u0442\u043E\u0432\u043E",r&&(s.classList.add("fw-admin-toast"),s.style.position="fixed",s.style.top=o.top,s.style.right=o.right,s.style.bottom="auto",s.style.left="auto",s.style.zIndex="10000",s.style.display="inline-block",s.style.height="auto",s.style.minHeight="0",s.style.maxHeight="none",s.style.maxWidth=o.maxWidth,s.style.width="auto",s.style.padding=o.padding,s.style.borderRadius=o.borderRadius,s.style.boxSizing="border-box",s.style.boxShadow="0 6px 18px rgba(0, 0, 0, 0.2)",s.style.color="#fff",s.style.fontWeight="500",s.style.fontSize=o.fontSize,s.style.lineHeight=o.lineHeight,s.style.whiteSpace="normal",s.style.overflowWrap="anywhere",s.style.wordBreak="break-word",s.style.opacity="0",s.style.transform="translateX(120%)",s.style.transition="opacity 0.25s ease, transform 0.25s ease"),document.body.appendChild(s),setTimeout(()=>{r?(s.style.opacity="1",s.style.transform="translateX(0)"):s.classList.add("show")},o.showDelayMs),setTimeout(()=>{r?(s.style.opacity="0",s.style.transform="translateX(120%)"):s.classList.remove("show"),setTimeout(()=>s.remove(),o.removeDelayMs)},o.durationMs)};document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add("content-loaded");let t=document.getElementById("header-placeholder"),e=document.getElementById("footer-placeholder"),a=window.location.pathname.includes("/other/"),r="../",o=`fw_header_${S}`,i=`fw_footer_${S}`,s=sessionStorage.getItem(o),n=sessionStorage.getItem(i);s&&n&&(t.innerHTML=s,e.innerHTML=n),Promise.all([s?Promise.resolve(s):fetch(`${r}includes/header.html?v=${S}`).then(l=>l.text()),n?Promise.resolve(n):fetch(`${r}includes/footer.html?v=${S}`).then(l=>l.text())]).then(([l,g])=>{s||sessionStorage.setItem(o,l),n||sessionStorage.setItem(i,g),t.innerHTML=l,e.innerHTML=g;let h=document.getElementById("copyright-year");h&&(h.textContent=String(new Date().getFullYear())),M(),window.refreshCartState&&window.refreshCartState();let w=document.getElementById("hamburger"),d=document.getElementById("mobile-menu");w&&d&&w.addEventListener("click",()=>{d.classList.toggle("active")});let c=document.querySelector(".scroll-top");c&&(window.addEventListener("scroll",()=>{c.classList.toggle("visible",window.scrollY>400)}),c.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})));let u=document.getElementById("auth-btn"),f=document.getElementById("user-sidebar"),p=document.getElementById("close-user-sidebar"),y=document.getElementById("user-logout");u&&f&&u.addEventListener("click",()=>{localStorage.getItem("isLoggedIn")==="true"?f.classList.add("active"):window.location.href="../other/login.html"}),p&&f&&p.addEventListener("click",()=>{f.classList.remove("active")}),y&&y.addEventListener("click",L=>{L.preventDefault(),confirm("\u0412\u044B\u0439\u0442\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430?")&&(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("jwtToken"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),window.location.href="../pages/index.html")})}).catch(l=>console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 header/footer:",l))});document.addEventListener("click",async t=>{let e=t.target.closest(".add-to-cart");if(!e)return;let a=e.dataset.id;!a||!window.toggleCartItem||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await window.toggleCartItem(a,1))},!0);function M(){let t=localStorage.getItem("isLoggedIn")==="true",e=localStorage.getItem("userName")||"\u0413\u043E\u0441\u0442\u044C",a=localStorage.getItem("userRole")||"USER",r=document.getElementById("auth-text"),o=document.getElementById("user-display-name"),i=document.getElementById("user-avatar");r&&(r.textContent=t?e:"\u0412\u043E\u0439\u0442\u0438"),o&&(o.textContent=e);let s=document.getElementById("admin-panel-menu-item"),n=document.getElementById("desktop-admin-link"),l=document.getElementById("mobile-admin-menu-item"),g=t&&a==="ADMIN";s&&(s.style.display=g?"":"none"),n&&(n.style.display=g?"":"none"),l&&(l.style.display=g?"":"none"),i&&(a==="ADMIN"?i.src="https://randomuser.me/api/portraits/men/1.jpg":i.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=e83e8c&color=fff`)}function v(t,e){if(!t)return;let a=t.dataset.originalText||t.textContent.trim()||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443";t.dataset.originalText||(t.dataset.originalText=a),e?(t.textContent="\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0435",t.classList.add("in-cart")):(t.textContent=t.dataset.originalText||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",t.classList.remove("in-cart"))}function T(t,e){if(!t)return;let a=String(t);document.querySelectorAll(`.add-to-cart[data-id="${a}"]`).forEach(o=>{v(o,e)});let r=document.getElementById("add-to-cart-btn");r&&String(r.dataset.id)===a&&v(r,e)}function E(t){let e=document.getElementById("cart-count-sidebar");e&&(e.textContent=String(t??0))}window.applyCartState=function(e){if(!e){E(0),document.querySelectorAll(".add-to-cart").forEach(n=>v(n,!1));let s=document.getElementById("add-to-cart-btn");s&&v(s,!1);return}if(typeof e!="object"||(window.__lastCartState=e,e.totalItems!==void 0&&E(e.totalItems||0),!Array.isArray(e.items)))return;let a=e.items,r=new Set(a.map(s=>String(s.productId??""))),o=new Map(a.map(s=>[String(s.productId??""),String(s.id??"")]));window.__cartItemByProductId=o,document.querySelectorAll(".add-to-cart").forEach(s=>{let n=s.dataset.id;n&&v(s,r.has(String(n)))});let i=document.getElementById("add-to-cart-btn");i&&i.dataset.id&&v(i,r.has(String(i.dataset.id)))};window.toggleCartItem=async function(e,a=1){if(!e)return;if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}let i=(window.__cartItemByProductId||new Map).get(String(e));try{let s=null;i?(s=await window.api.removeFromCart(i),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info"),T(e,!1)):(s=await window.api.addToCart(e,a),showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),T(e,!0)),s&&window.applyCartState&&window.applyCartState(s),window.refreshCartState&&window.refreshCartState()}catch(s){showToast(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}};window.refreshCartState=async function(){if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){window.applyCartState(null);return}try{if(window.api&&typeof window.api.getCart=="function"){let r=await window.api.getCart();r&&typeof r=="object"&&window.applyCartState(r);return}let a=await fetch("http://localhost:8080/api/cart",{headers:{Authorization:`Bearer ${localStorage.getItem("jwtToken")}`}});if(a.ok){let r=await a.json();r&&typeof r=="object"&&window.applyCartState(r)}else window.applyCartState(null)}catch(a){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u043E\u0440\u0437\u0438\u043D\u044B:",a),window.applyCartState(null)}};(function(){let e=window.location.hostname;if(!(e==="localhost"||e==="127.0.0.1")||document.querySelector("script[data-livereload]"))return;let r=document.createElement("script");r.src=`http://${e}:35729/livereload.js?snipver=1`,r.async=!0,r.setAttribute("data-livereload","true"),document.body.appendChild(r)})();var $="http://localhost:8080/api",k={get token(){return localStorage.getItem("jwtToken")},set token(t){t?localStorage.setItem("jwtToken",t):localStorage.removeItem("jwtToken")},headers(){let t={"Content-Type":"application/json"};return this.token&&(t.Authorization=`Bearer ${this.token}`),t},async request(t,e={}){let a=await fetch($+t,{...e,headers:{...this.headers(),...e.headers}});if(a.status===401)throw this.token=null,localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userRole"),window.location.href="../other/login.html",new Error("Unauthorized");if(a.status===403)throw new Error("\u0414\u043E\u0441\u0442\u0443\u043F \u0437\u0430\u043F\u0440\u0435\u0449\u0451\u043D");if(!a.ok){let o=await a.text().catch(()=>"Unknown error");throw new Error(o||a.statusText)}if(a.status===204)return null;let r=await a.text();if(!r)return null;try{return JSON.parse(r)}catch{return r}},login(t){return this.request("/auth/login",{method:"POST",body:JSON.stringify(t)})},register(t){return this.request("/auth/register",{method:"POST",body:JSON.stringify(t)})},forgotPassword(t){return this.request("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:t})})},resetPassword(t,e){return this.request("/auth/reset-password",{method:"POST",body:JSON.stringify({token:t,newPassword:e})})},getProducts(t={}){let e=new URLSearchParams(t).toString();return this.request(`/products?${e}`)},getProductBySlug(t){return this.request(`/products/${t}`)},getProductById(t){return this.request(`/products/id/${t}`)},getHits(){return this.request("/products/hits")},getNew(){return this.request("/products/new")},getCategories(){return this.request("/categories")},getCategoryBySlug(t){return this.request(`/categories/${t}`)},getCategoryById(t){return this.request(`/categories/id/${t}`)},getCart(){return this.request("/cart")},addToCart(t,e=1){return this.request("/cart/items",{method:"POST",body:JSON.stringify({productId:t,quantity:e})})},updateCartItem(t,e){return this.request(`/cart/items/${t}?quantity=${e}`,{method:"PUT"})},removeFromCart(t){return this.request(`/cart/items/${t}`,{method:"DELETE"})},clearCart(){return this.request("/cart",{method:"DELETE"})},getFavorites(){return this.request("/favorites")},addToFavorite(t){return this.request(`/favorites/${t}`,{method:"POST"})},removeFromFavorite(t){return this.request(`/favorites/${t}`,{method:"DELETE"})},isFavorite(t){return this.request(`/favorites/check/${t}`)},getMyOrders(){return this.request("/orders/my")},getOrderById(t){return this.request(`/orders/${t}`)},createOrder(t){return this.request("/orders",{method:"POST",body:JSON.stringify(t)})},getProductReviews(t){return this.request(`/reviews/product/${t}`)},getRecentReviews(t=3){return this.request(`/reviews/recent?limit=${t}`)},createReview(t,e,a){let r=localStorage.getItem("userName")||"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C";return this.request("/reviews",{method:"POST",body:JSON.stringify({productId:t,authorName:r,rating:e,text:a})})},getTestimonials(){return this.request("/content/testimonials")},getTeamMembers(){return this.request("/content/team")},getBlogPosts(t=0,e=10){return this.request(`/content/blog?page=${t}&size=${e}`)},getBlogPostBySlug(t){return this.request(`/content/blog/${t}`)},getDashboard(){return this.request("/admin/dashboard")},getAdminProducts(){return this.request("/admin/products")},getArchivedAdminProducts(){return this.request("/admin/products/archive")},createProduct(t){return this.request("/admin/products",{method:"POST",body:JSON.stringify(t)})},updateProduct(t,e){return this.request(`/admin/products/${t}`,{method:"PUT",body:JSON.stringify(e)})},updateProductPartial(t,e){return this.request(`/admin/products/${t}`,{method:"PATCH",body:JSON.stringify(e)})},uploadProductImage(t,e,a=!1){let r=new FormData;return r.append("file",e),r.append("isMain",a?"true":"false"),fetch(`${$}/products/${t}/images/upload`,{method:"POST",headers:this.token?{Authorization:`Bearer ${this.token}`}:{},body:r}).then(async o=>{if(!o.ok){let i=await o.text().catch(()=>"Upload error");throw new Error(i||o.statusText)}return o.json()})},deleteProduct(t){return this.request(`/admin/products/${t}`,{method:"DELETE"})},restoreProduct(t){return this.request(`/admin/products/${t}/restore`,{method:"POST"})},getAdminOrders(t=0,e=10){return this.request(`/admin/orders?page=${t}&size=${e}`)},getAdminOrderById(t){return this.request(`/admin/orders/${t}`)},updateOrderStatus(t,e){return this.request(`/admin/orders/${t}/status?status=${e}`,{method:"PUT"})},getAdminCategories(){return this.request("/admin/categories")},createCategory(t){return this.request("/admin/categories",{method:"POST",body:JSON.stringify(t)})},updateCategory(t,e){return this.request(`/admin/categories/${t}`,{method:"PUT",body:JSON.stringify(e)})},deleteCategory(t){return this.request(`/admin/categories/${t}`,{method:"DELETE"})},getAdminUsers(t=0,e=10){return this.request(`/admin/users?page=${t}&size=${e}`)},updateUserStatus(t,e){return this.request(`/admin/users/${t}/status?isActive=${e}`,{method:"PUT"})},deleteUser(t){return this.request(`/admin/users/${t}`,{method:"DELETE"})},getPendingReviews(t=0,e=10){return this.request(`/reviews/pending?page=${t}&size=${e}`)},approveReview(t){return this.request(`/reviews/${t}/approve`,{method:"POST"})},rejectReview(t){return this.request(`/reviews/${t}/reject`,{method:"POST"})}};window.api=k;window.isLoggedIn=function(){return localStorage.getItem("isLoggedIn")==="true"};window.isAdmin=function(){return localStorage.getItem("userRole")==="ADMIN"&&window.isLoggedIn()};window.getJwtToken=function(){return localStorage.getItem("jwtToken")};var I=null;async function O(){try{let t=await api.getHits();F(t.slice(0,3))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043F\u0443\u043B\u044F\u0440\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432:",t)}}function F(t){let e=document.querySelector(".popular .product-grid");e&&(e.innerHTML=t.map(a=>{let r=a.images?.find(i=>i.isMain)?.imagePath||a.images?.[0]?.imagePath||"../images/placeholder.jpg",o=window.resolveAssetUrl?window.resolveAssetUrl(r):r;return`
        <div class="product-card" data-id="${a.id}">
            <div class="product-img" style="background-image: url('${o}')">
                ${a.oldPrice?'<span class="product-badge">\u0421\u043A\u0438\u0434\u043A\u0430</span>':""}
                <button class="wishlist-btn"><i class="far fa-heart"></i></button>
            </div>
            <div class="product-info">
                <h3>${a.name}</h3>
                <p>${a.description||""}</p>
                <div class="product-rating">
                    ${'<i class="fas fa-star"></i>'.repeat(Math.floor(a.ratingAverage||5))}
                    <span>(${a.reviewsCount||0})</span>
                </div>
                <div class="product-price">
                    <span class="current-price">${a.price.toLocaleString()} \u20BD</span>
                    ${a.oldPrice?`<span class="old-price">${a.oldPrice.toLocaleString()} \u20BD</span>`:""}
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${a.id}"
                        data-name="${a.name}"
                        data-price="${a.price}"
                        data-image="${o}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        </div>
    `}).join(""),N(e),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState())}function N(t){t.querySelectorAll(".product-card").forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",a=>{if(a.target.closest(".add-to-cart")||a.target.closest(".wishlist-btn"))return;let r=e.dataset.id;r&&(window.location.href=`product.html?id=${r}`)})}),t.querySelectorAll(".add-to-cart").forEach(e=>{e.addEventListener("click",async a=>{a.preventDefault();let{id:r}=e.dataset;window.toggleCartItem?await window.toggleCartItem(r,1):await U(r,1)})}),t.querySelectorAll(".wishlist-btn i").forEach(async e=>{let r=e.closest(".product-card")?.querySelector(".add-to-cart");if(!r)return;let o=r.dataset.id;if(isLoggedIn())try{await api.isFavorite(o)&&(e.classList.add("fas","active"),e.classList.remove("far"))}catch{}e.addEventListener("click",async()=>{if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(o)?(await api.removeFromFavorite(o),e.classList.remove("fas","active"),e.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(o),e.classList.remove("far"),e.classList.add("fas","active"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(i){showToast(i.message,"error")}})})}async function U(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(t,e);else{let a=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(a):b()}}catch(a){showToast(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function b(){window.refreshCartState&&await window.refreshCartState()}async function _(){try{let t=await api.getCategories();D(t.slice(0,4))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",t)}}function D(t){let e=document.querySelector(".categories .category-grid");!e||t.length===0||(e.innerHTML=t.map(a=>`
        <a href="category.html?id=${a.id}" class="category-card">
            <div class="category-img" style="background-image: url('${window.resolveAssetUrl?window.resolveAssetUrl(a.imagePath||"../images/placeholder.jpg"):a.imagePath||"../images/placeholder.jpg"}')"></div>
            <h3>${a.name}</h3>
        </a>
    `).join(""))}async function R(){try{let t=await api.getRecentReviews(20);j(t),z()}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043E\u0442\u0437\u044B\u0432\u043E\u0432:",t)}}function H(t){let e=(t||"").trim();if(!e)return"\u041A";let a=e.split(/\s+/).filter(Boolean);return a.length>=2?`${a[0][0]}${a[1][0]}`.toUpperCase():e.slice(0,2).toUpperCase()}function j(t){let e=document.querySelector(".testimonials .testimonial-slider");if(e){if(!Array.isArray(t)||t.length===0){e.innerHTML='<p class="loading">\u041F\u043E\u043A\u0430 \u043D\u0435\u0442 \u043E\u0442\u0437\u044B\u0432\u043E\u0432</p>';return}e.innerHTML=t.map((a,r)=>`
        <div class="testimonial-slide ${r===0?"active":""}">
            <div class="testimonial-content">
                <div class="rating">
                    ${'<i class="fas fa-star"></i>'.repeat(a.rating||5)}
                    ${'<i class="far fa-star"></i>'.repeat(Math.max(0,5-(a.rating||5)))}
                </div>
                <p class="testimonial-text">"${a.text||"\u0411\u0435\u0437 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F"}"</p>
                <div class="client-info">
                    <div class="client-photo">${H(a.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442")}</div>
                    <div class="client-details">
                        <h4>${a.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442"}</h4>
                        <p>${a.product?.name||"\u0417\u0430\u043A\u0430\u0437"}</p>
                    </div>
                </div>
            </div>
        </div>
    `).join("")}}function z(){let t=document.querySelectorAll(".testimonial-slide");if(t.length<=1)return;I&&clearInterval(I);let e=0;I=setInterval(()=>{t[e].classList.remove("active"),e=(e+1)%t.length,t[e].classList.add("active")},6e3)}document.addEventListener("DOMContentLoaded",()=>{O(),_(),R(),b(),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(e){e.preventDefault();let a=this.getAttribute("href");if(a==="#")return;let r=document.querySelector(a);r&&r.scrollIntoView({behavior:"smooth"})})})});var m=null;async function C(){let t=document.getElementById("cart-items"),e=document.getElementById("cart-empty"),a=document.getElementById("cart-summary"),r=document.getElementById("total-price"),o=document.getElementById("cart-count-sidebar");if(!t)return;if(!isLoggedIn()){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-lock" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u043E\u0439\u0434\u0438\u0442\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C
                </p>
                <a href="../other/login.html" class="btn">\u0412\u043E\u0439\u0442\u0438</a>
            </div>
        `,a.style.display="none",r&&(r.textContent="0");return}try{m=await api.getCart()}catch(n){t.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u043E\u0440\u0437\u0438\u043D\u044B: ${n.message}</p>`,e.style.display="none",a.style.display="none";return}window.applyCartState&&window.applyCartState(m);let i=m.items||[];if(o&&(o.textContent=m.totalItems||0),i.length===0){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u0438\u0437 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430, \u0447\u0442\u043E\u0431\u044B \u043E\u0444\u043E\u0440\u043C\u0438\u0442\u044C \u0437\u0430\u043A\u0430\u0437
                </p>
                <a href="../pages/catalog.html" class="btn">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433</a>
            </div>
        `,a.style.display="none",r&&(r.textContent="0");return}t.innerHTML="";let s=0;i.forEach(n=>{let l=n.totalPrice||n.price*(n.quantity||1);s+=l;let g=n.productImage||"../images/placeholder.jpg",h=window.resolveAssetUrl?window.resolveAssetUrl(g):g,w=document.createElement("div");w.className="cart-item",w.innerHTML=`
            <div class="cart-item-img" style="background-image: url('${h}')"></div>
            <div class="cart-item-info">
                <h4>${n.productName}</h4>
                <p>${n.price.toLocaleString()} \u20BD</p>
            </div>
            <div class="cart-item-quantity">
                <button class="qty-btn" onclick="changeQuantity('${n.id}', -1)">\u2212</button>
                <span>${n.quantity||1}</span>
                <button class="qty-btn" onclick="changeQuantity('${n.id}', 1)">+</button>
            </div>
            <div class="cart-item-total">
                ${l.toLocaleString()} \u20BD
            </div>
            <button class="remove-from-cart" data-item-id="${n.id}">\xD7</button>
        `,t.appendChild(w)}),r&&(r.textContent=m.totalPrice?m.totalPrice.toLocaleString():s.toLocaleString()),t.style.display="block",e.style.display="none",a.style.display="block",t.querySelectorAll(".remove-from-cart").forEach(n=>{n.addEventListener("click",async()=>{let l=n.dataset.itemId;try{m=await api.removeFromCart(l),await C(),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info")}catch(g){showToast(g.message,"error")}})})}window.changeQuantity=async function(t,e){if(!m)return;let a=m.items.find(o=>o.id==t);if(!a)return;let r=Math.max(1,(a.quantity||1)+e);try{m=await api.updateCartItem(t,r),await C(),showToast("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430","success")}catch(o){showToast(o.message,"error")}};async function J(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{let a=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),document.getElementById("cart-items")&&(m=a),window.applyCartState?window.applyCartState(a):W()}catch(a){showToast(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}function W(){window.applyCartState&&m&&window.applyCartState(m)}async function Q(){if(!isLoggedIn())return JSON.parse(localStorage.getItem("favorites"))||[];try{return await api.getFavorites()}catch{return[]}}async function q(t,e,a,r,o){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u044B\u043C","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(t)?(await api.removeFromFavorite(t),o&&(o.classList.remove("fas","active"),o.classList.add("far")),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(t),o&&(o.classList.remove("far"),o.classList.add("fas","active")),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success")),document.getElementById("favorites-list")&&P()}catch(i){showToast(i.message,"error")}}async function P(){let t=document.getElementById("favorites-list"),e=document.getElementById("favorites-empty");if(!t)return;let a=await Q();if(!a||a.length===0){t.style.display="none",e.style.display="block";return}t.innerHTML="",a.forEach(r=>{let o=document.createElement("div");o.className="product-card";let i=r.product?.id||r.productId,s=r.product?.name||r.name||"\u0422\u043E\u0432\u0430\u0440",n=r.product?.price||r.price||0,l=r.product?.images?.[0]?.imagePath||r.image||"../images/placeholder.jpg",g=window.resolveAssetUrl?window.resolveAssetUrl(l):l;i&&(o.dataset.id=i,o.innerHTML=`
            <div class="product-img" style="background-image: url('${g}')">
                <button class="wishlist-btn">
                    <i class="fas fa-heart active" data-id="${i}"></i>
                </button>
            </div>
            <div class="product-info">
                <h3>${s}</h3>
                <div class="product-price">
                    <span class="current-price">${n.toLocaleString()} \u20BD</span>
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${i}"
                        data-name="${s}"
                        data-price="${n}"
                        data-image="${g}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        `,t.appendChild(o),o.addEventListener("click",h=>{if(h.target.closest(".add-to-cart")||h.target.closest(".wishlist-btn"))return;let w=o.dataset.id;w&&(window.location.href=`product.html?id=${w}`)}))}),t.style.display="grid",e.style.display="none",window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState(),t.querySelectorAll(".wishlist-btn i").forEach(r=>{r.addEventListener("click",()=>{let o=r.dataset.id;q(o,"",0,"",r)})})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("cart-items")&&C(),document.getElementById("favorites-list")&&P(),document.querySelectorAll(".add-to-cart").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();let{id:a}=t.dataset;window.toggleCartItem?window.toggleCartItem(a,1):J(a,1)})}),document.querySelectorAll(".wishlist-btn i").forEach(t=>{let a=t.closest(".product-card")?.querySelector(".add-to-cart");if(!a)return;let r=a.dataset.id,o=a.dataset.name,i=a.dataset.price,s=a.dataset.image;isLoggedIn()&&api.isFavorite(r).then(n=>{n&&(t.classList.remove("far"),t.classList.add("fas","active"))}).catch(()=>{}),t.addEventListener("click",()=>{q(r,o,i,s,t)})})});function x(t){t=t.replace(/[\[\]]/g,"\\$&");let a=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(window.location.href);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null}document.addEventListener("DOMContentLoaded",async()=>{let t=x("id"),e=x("slug"),a=document.getElementById("category-title"),r=document.getElementById("category-description"),o=document.getElementById("current-category"),i=document.getElementById("products-container");if(!i)return;let s=null,n=[];try{t?s=await api.getCategoryById(t):e&&(s=await api.getCategoryBySlug(e)),s?(a.textContent=s.name,r.textContent=s.description||`\u0411\u0443\u043A\u0435\u0442\u044B \u0432 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \xAB${s.name}\xBB`,o&&(o.textContent=s.name)):(a.textContent="\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430",r.textContent="\u0412\u0435\u0440\u043D\u0438\u0442\u0435\u0441\u044C \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433 \u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u043D\u0442\u0435\u0440\u0435\u0441\u0443\u044E\u0449\u0443\u044E \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E");let d=await api.getProducts({categoryId:t||s?.id,page:0,size:200});n=d.content||d,l(n)}catch(d){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438:",d),i.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438: ${d.message}</p>`}function l(d){if(i.innerHTML="",d.length===0){i.innerHTML='<p class="text-center">\u0412 \u044D\u0442\u043E\u0439 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432</p>';return}d.forEach(c=>{let u=document.createElement("div");u.className="product-card",u.style.cursor="pointer";let f=c.images?.find(y=>y.isMain)?.imagePath||c.images?.[0]?.imagePath||"../images/placeholder.jpg",p=window.resolveAssetUrl?window.resolveAssetUrl(f):f;u.innerHTML=`
                <div class="product-img" style="background-image: url('${p}')">
                    ${c.oldPrice?'<span class="product-badge">\u0421\u043A\u0438\u0434\u043A\u0430</span>':""}
                    <button class="wishlist-btn"><i class="far fa-heart"></i></button>
                </div>
                <div class="product-info">
                    <h3>${c.name}</h3>
                    <p>${c.description||""}</p>
                    <div class="product-rating">
                        ${'<i class="fas fa-star"></i>'.repeat(Math.floor(c.ratingAverage||0))}
                        ${(c.ratingAverage||0)%1?'<i class="fas fa-star-half-alt"></i>':""}
                        ${'<i class="far fa-star"></i>'.repeat(5-Math.ceil(c.ratingAverage||0))}
                        <span>(${c.reviewsCount||0})</span>
                    </div>
                    <div class="product-price">
                        <span class="current-price">${c.price.toLocaleString()} \u20BD</span>
                        ${c.oldPrice?`<span class="old-price">${c.oldPrice.toLocaleString()} \u20BD</span>`:""}
                    </div>
                    <button class="btn btn-small add-to-cart"
                            data-id="${c.id}"
                            data-name="${c.name}"
                            data-price="${c.price}"
                            data-image="${p}">
                        \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                    </button>
                </div>
            `,i.appendChild(u),u.addEventListener("click",y=>{y.target.closest(".add-to-cart")||y.target.closest(".wishlist-btn")||(window.location.href=`product.html?id=${c.id}`)})}),g(),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState()}function g(){i.querySelectorAll(".add-to-cart").forEach(d=>{d.addEventListener("click",async c=>{c.preventDefault();let{id:u}=d.dataset;window.toggleCartItem?await window.toggleCartItem(u,1):await h(u,1)})}),i.querySelectorAll(".wishlist-btn i").forEach(async d=>{let u=d.closest(".product-card")?.querySelector(".add-to-cart");if(!u)return;let f=u.dataset.id;if(isLoggedIn())try{await api.isFavorite(f)&&(d.classList.add("fas","active"),d.classList.remove("far"))}catch{}d.addEventListener("click",async()=>{if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(f)?(await api.removeFromFavorite(f),d.classList.remove("fas","active"),d.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(f),d.classList.remove("far"),d.classList.add("fas","active"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(p){showToast(p.message,"error")}})})}async function h(d,c=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(d,c);else{let u=await api.addToCart(d,c);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(u):w()}}catch(u){showToast(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function w(){window.refreshCartState&&await window.refreshCartState()}});})();
