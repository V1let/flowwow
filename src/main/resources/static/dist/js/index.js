(()=>{function x(t){if(!t||typeof t!="string")return t;let e=t.trim();if(!e||/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e))return e;let r="http://localhost:8080";return e.startsWith("/api/")?`${r}${e}`:e.startsWith("api/")?`${r}/${e}`:e}window.resolveAssetUrl=x;window.toastConfig={default:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800},admin:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800,top:"16px",right:"16px",maxWidth:"320px",padding:"10px 14px",borderRadius:"8px",fontSize:"14px",lineHeight:"1.35"}};function A(t){let e=t?window.toastConfig.admin:window.toastConfig.default,r=window.toastOverrides&&typeof window.toastOverrides=="object"?window.toastOverrides:{};return{...e,...r}}var p="3";window.showToast=function(e,r="success"){let a=window.location.pathname.includes("/other/admin"),s=A(a),i=String(e??"").replace(/\s+/g," ").trim().slice(0,s.maxMessageLength),o=document.createElement("div");o.className=`toast-notification ${r}`,o.textContent=i||"\u0413\u043E\u0442\u043E\u0432\u043E",a&&(o.classList.add("fw-admin-toast"),o.style.position="fixed",o.style.top=s.top,o.style.right=s.right,o.style.bottom="auto",o.style.left="auto",o.style.zIndex="10000",o.style.display="inline-block",o.style.height="auto",o.style.minHeight="0",o.style.maxHeight="none",o.style.maxWidth=s.maxWidth,o.style.width="auto",o.style.padding=s.padding,o.style.borderRadius=s.borderRadius,o.style.boxSizing="border-box",o.style.boxShadow="0 6px 18px rgba(0, 0, 0, 0.2)",o.style.color="#fff",o.style.fontWeight="500",o.style.fontSize=s.fontSize,o.style.lineHeight=s.lineHeight,o.style.whiteSpace="normal",o.style.overflowWrap="anywhere",o.style.wordBreak="break-word",o.style.opacity="0",o.style.transform="translateX(120%)",o.style.transition="opacity 0.25s ease, transform 0.25s ease"),document.body.appendChild(o),setTimeout(()=>{a?(o.style.opacity="1",o.style.transform="translateX(0)"):o.classList.add("show")},s.showDelayMs),setTimeout(()=>{a?(o.style.opacity="0",o.style.transform="translateX(120%)"):o.classList.remove("show"),setTimeout(()=>o.remove(),s.removeDelayMs)},s.durationMs)};document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add("content-loaded");let t=document.getElementById("header-placeholder"),e=document.getElementById("footer-placeholder"),r=window.location.pathname.includes("/other/"),a="../",s=`fw_header_${p}`,i=`fw_footer_${p}`,o=sessionStorage.getItem(s),n=sessionStorage.getItem(i);o&&n&&(t.innerHTML=o,e.innerHTML=n),Promise.all([o?Promise.resolve(o):fetch(`${a}includes/header.html?v=${p}`).then(d=>d.text()),n?Promise.resolve(n):fetch(`${a}includes/footer.html?v=${p}`).then(d=>d.text())]).then(([d,c])=>{o||sessionStorage.setItem(s,d),n||sessionStorage.setItem(i,c),t.innerHTML=d,e.innerHTML=c;let m=document.getElementById("copyright-year");m&&(m.textContent=String(new Date().getFullYear())),B(),window.refreshCartState&&window.refreshCartState();let u=document.getElementById("hamburger"),v=document.getElementById("mobile-menu");u&&v&&u.addEventListener("click",()=>{v.classList.toggle("active")});let f=document.querySelector(".scroll-top");f&&(window.addEventListener("scroll",()=>{f.classList.toggle("visible",window.scrollY>400)}),f.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})));let S=document.getElementById("auth-btn"),h=document.getElementById("user-sidebar"),I=document.getElementById("close-user-sidebar"),C=document.getElementById("user-logout");S&&h&&S.addEventListener("click",()=>{localStorage.getItem("isLoggedIn")==="true"?h.classList.add("active"):window.location.href="../other/login.html"}),I&&h&&I.addEventListener("click",()=>{h.classList.remove("active")}),C&&C.addEventListener("click",T=>{T.preventDefault(),confirm("\u0412\u044B\u0439\u0442\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430?")&&(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("jwtToken"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),window.location.href="../pages/index.html")})}).catch(d=>console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 header/footer:",d))});document.addEventListener("click",async t=>{let e=t.target.closest(".add-to-cart");if(!e)return;let r=e.dataset.id;!r||!window.toggleCartItem||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await window.toggleCartItem(r,1))},!0);function B(){let t=localStorage.getItem("isLoggedIn")==="true",e=localStorage.getItem("userName")||"\u0413\u043E\u0441\u0442\u044C",r=localStorage.getItem("userRole")||"USER",a=document.getElementById("auth-text"),s=document.getElementById("user-display-name"),i=document.getElementById("user-avatar");a&&(a.textContent=t?e:"\u0412\u043E\u0439\u0442\u0438"),s&&(s.textContent=e);let o=document.getElementById("admin-panel-menu-item"),n=document.getElementById("desktop-admin-link"),d=document.getElementById("mobile-admin-menu-item"),c=t&&r==="ADMIN";o&&(o.style.display=c?"":"none"),n&&(n.style.display=c?"":"none"),d&&(d.style.display=c?"":"none"),i&&(r==="ADMIN"?i.src="https://randomuser.me/api/portraits/men/1.jpg":i.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=e83e8c&color=fff`)}function g(t,e){if(!t)return;let r=t.dataset.originalText||t.textContent.trim()||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443";t.dataset.originalText||(t.dataset.originalText=r),e?(t.textContent="\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0435",t.classList.add("in-cart")):(t.textContent=t.dataset.originalText||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",t.classList.remove("in-cart"))}function L(t,e){if(!t)return;let r=String(t);document.querySelectorAll(`.add-to-cart[data-id="${r}"]`).forEach(s=>{g(s,e)});let a=document.getElementById("add-to-cart-btn");a&&String(a.dataset.id)===r&&g(a,e)}function E(t){let e=document.getElementById("cart-count-sidebar");e&&(e.textContent=String(t??0))}window.applyCartState=function(e){if(!e){E(0),document.querySelectorAll(".add-to-cart").forEach(n=>g(n,!1));let o=document.getElementById("add-to-cart-btn");o&&g(o,!1);return}if(typeof e!="object"||(window.__lastCartState=e,e.totalItems!==void 0&&E(e.totalItems||0),!Array.isArray(e.items)))return;let r=e.items,a=new Set(r.map(o=>String(o.productId??""))),s=new Map(r.map(o=>[String(o.productId??""),String(o.id??"")]));window.__cartItemByProductId=s,document.querySelectorAll(".add-to-cart").forEach(o=>{let n=o.dataset.id;n&&g(o,a.has(String(n)))});let i=document.getElementById("add-to-cart-btn");i&&i.dataset.id&&g(i,a.has(String(i.dataset.id)))};window.toggleCartItem=async function(e,r=1){if(!e)return;if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}let i=(window.__cartItemByProductId||new Map).get(String(e));try{let o=null;i?(o=await window.api.removeFromCart(i),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info"),L(e,!1)):(o=await window.api.addToCart(e,r),showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),L(e,!0)),o&&window.applyCartState&&window.applyCartState(o),window.refreshCartState&&window.refreshCartState()}catch(o){showToast(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}};window.refreshCartState=async function(){if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){window.applyCartState(null);return}try{if(window.api&&typeof window.api.getCart=="function"){let a=await window.api.getCart();a&&typeof a=="object"&&window.applyCartState(a);return}let r=await fetch("http://localhost:8080/api/cart",{headers:{Authorization:`Bearer ${localStorage.getItem("jwtToken")}`}});if(r.ok){let a=await r.json();a&&typeof a=="object"&&window.applyCartState(a)}else window.applyCartState(null)}catch(r){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u043E\u0440\u0437\u0438\u043D\u044B:",r),window.applyCartState(null)}};(function(){let e=window.location.hostname;if(!(e==="localhost"||e==="127.0.0.1")||document.querySelector("script[data-livereload]"))return;let a=document.createElement("script");a.src=`http://${e}:35729/livereload.js?snipver=1`,a.async=!0,a.setAttribute("data-livereload","true"),document.body.appendChild(a)})();var $="http://localhost:8080/api",k={get token(){return localStorage.getItem("jwtToken")},set token(t){t?localStorage.setItem("jwtToken",t):localStorage.removeItem("jwtToken")},headers(){let t={"Content-Type":"application/json"};return this.token&&(t.Authorization=`Bearer ${this.token}`),t},async request(t,e={}){let r=await fetch($+t,{...e,headers:{...this.headers(),...e.headers}});if(r.status===401)throw this.token=null,localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userRole"),window.location.href="../other/login.html",new Error("Unauthorized");if(r.status===403)throw new Error("\u0414\u043E\u0441\u0442\u0443\u043F \u0437\u0430\u043F\u0440\u0435\u0449\u0451\u043D");if(!r.ok){let s=await r.text().catch(()=>"Unknown error");throw new Error(s||r.statusText)}if(r.status===204)return null;let a=await r.text();if(!a)return null;try{return JSON.parse(a)}catch{return a}},login(t){return this.request("/auth/login",{method:"POST",body:JSON.stringify(t)})},register(t){return this.request("/auth/register",{method:"POST",body:JSON.stringify(t)})},forgotPassword(t){return this.request("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:t})})},resetPassword(t,e){return this.request("/auth/reset-password",{method:"POST",body:JSON.stringify({token:t,newPassword:e})})},getProducts(t={}){let e=new URLSearchParams(t).toString();return this.request(`/products?${e}`)},getProductBySlug(t){return this.request(`/products/${t}`)},getProductById(t){return this.request(`/products/id/${t}`)},getHits(){return this.request("/products/hits")},getNew(){return this.request("/products/new")},getCategories(){return this.request("/categories")},getCategoryBySlug(t){return this.request(`/categories/${t}`)},getCategoryById(t){return this.request(`/categories/id/${t}`)},getCart(){return this.request("/cart")},addToCart(t,e=1){return this.request("/cart/items",{method:"POST",body:JSON.stringify({productId:t,quantity:e})})},updateCartItem(t,e){return this.request(`/cart/items/${t}?quantity=${e}`,{method:"PUT"})},removeFromCart(t){return this.request(`/cart/items/${t}`,{method:"DELETE"})},clearCart(){return this.request("/cart",{method:"DELETE"})},getFavorites(){return this.request("/favorites")},addToFavorite(t){return this.request(`/favorites/${t}`,{method:"POST"})},removeFromFavorite(t){return this.request(`/favorites/${t}`,{method:"DELETE"})},isFavorite(t){return this.request(`/favorites/check/${t}`)},getMyOrders(){return this.request("/orders/my")},getOrderById(t){return this.request(`/orders/${t}`)},createOrder(t){return this.request("/orders",{method:"POST",body:JSON.stringify(t)})},getProductReviews(t){return this.request(`/reviews/product/${t}`)},getRecentReviews(t=3){return this.request(`/reviews/recent?limit=${t}`)},createReview(t,e,r){let a=localStorage.getItem("userName")||"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C";return this.request("/reviews",{method:"POST",body:JSON.stringify({productId:t,authorName:a,rating:e,text:r})})},getTestimonials(){return this.request("/content/testimonials")},getTeamMembers(){return this.request("/content/team")},getBlogPosts(t=0,e=10){return this.request(`/content/blog?page=${t}&size=${e}`)},getBlogPostBySlug(t){return this.request(`/content/blog/${t}`)},getDashboard(){return this.request("/admin/dashboard")},getAdminProducts(){return this.request("/admin/products")},getArchivedAdminProducts(){return this.request("/admin/products/archive")},createProduct(t){return this.request("/admin/products",{method:"POST",body:JSON.stringify(t)})},updateProduct(t,e){return this.request(`/admin/products/${t}`,{method:"PUT",body:JSON.stringify(e)})},updateProductPartial(t,e){return this.request(`/admin/products/${t}`,{method:"PATCH",body:JSON.stringify(e)})},uploadProductImage(t,e,r=!1){let a=new FormData;return a.append("file",e),a.append("isMain",r?"true":"false"),fetch(`${$}/products/${t}/images/upload`,{method:"POST",headers:this.token?{Authorization:`Bearer ${this.token}`}:{},body:a}).then(async s=>{if(!s.ok){let i=await s.text().catch(()=>"Upload error");throw new Error(i||s.statusText)}return s.json()})},deleteProduct(t){return this.request(`/admin/products/${t}`,{method:"DELETE"})},restoreProduct(t){return this.request(`/admin/products/${t}/restore`,{method:"POST"})},getAdminOrders(t=0,e=10){return this.request(`/admin/orders?page=${t}&size=${e}`)},getAdminOrderById(t){return this.request(`/admin/orders/${t}`)},updateOrderStatus(t,e){return this.request(`/admin/orders/${t}/status?status=${e}`,{method:"PUT"})},getAdminCategories(){return this.request("/admin/categories")},createCategory(t){return this.request("/admin/categories",{method:"POST",body:JSON.stringify(t)})},updateCategory(t,e){return this.request(`/admin/categories/${t}`,{method:"PUT",body:JSON.stringify(e)})},deleteCategory(t){return this.request(`/admin/categories/${t}`,{method:"DELETE"})},getAdminUsers(t=0,e=10){return this.request(`/admin/users?page=${t}&size=${e}`)},updateUserStatus(t,e){return this.request(`/admin/users/${t}/status?isActive=${e}`,{method:"PUT"})},deleteUser(t){return this.request(`/admin/users/${t}`,{method:"DELETE"})},getPendingReviews(t=0,e=10){return this.request(`/reviews/pending?page=${t}&size=${e}`)},approveReview(t){return this.request(`/reviews/${t}/approve`,{method:"POST"})},rejectReview(t){return this.request(`/reviews/${t}/reject`,{method:"POST"})}};window.api=k;window.isLoggedIn=function(){return localStorage.getItem("isLoggedIn")==="true"};window.isAdmin=function(){return localStorage.getItem("userRole")==="ADMIN"&&window.isLoggedIn()};window.getJwtToken=function(){return localStorage.getItem("jwtToken")};var w=null;async function M(){try{let t=await api.getHits();O(t.slice(0,3))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043F\u0443\u043B\u044F\u0440\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432:",t)}}function O(t){let e=document.querySelector(".popular .product-grid");e&&(e.innerHTML=t.map(r=>{let a=r.images?.find(i=>i.isMain)?.imagePath||r.images?.[0]?.imagePath||"../images/placeholder.jpg",s=window.resolveAssetUrl?window.resolveAssetUrl(a):a;return`
        <div class="product-card" data-id="${r.id}">
            <div class="product-img" style="background-image: url('${s}')">
                ${r.oldPrice?'<span class="product-badge">\u0421\u043A\u0438\u0434\u043A\u0430</span>':""}
                <button class="wishlist-btn"><i class="far fa-heart"></i></button>
            </div>
            <div class="product-info">
                <h3>${r.name}</h3>
                <p>${r.description||""}</p>
                <div class="product-rating">
                    ${'<i class="fas fa-star"></i>'.repeat(Math.floor(r.ratingAverage||5))}
                    <span>(${r.reviewsCount||0})</span>
                </div>
                <div class="product-price">
                    <span class="current-price">${r.price.toLocaleString()} \u20BD</span>
                    ${r.oldPrice?`<span class="old-price">${r.oldPrice.toLocaleString()} \u20BD</span>`:""}
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${r.id}"
                        data-name="${r.name}"
                        data-price="${r.price}"
                        data-image="${s}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        </div>
    `}).join(""),N(e),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState())}function N(t){t.querySelectorAll(".product-card").forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",r=>{if(r.target.closest(".add-to-cart")||r.target.closest(".wishlist-btn"))return;let a=e.dataset.id;a&&(window.location.href=`product.html?id=${a}`)})}),t.querySelectorAll(".add-to-cart").forEach(e=>{e.addEventListener("click",async r=>{r.preventDefault();let{id:a}=e.dataset;window.toggleCartItem?await window.toggleCartItem(a,1):await F(a,1)})}),t.querySelectorAll(".wishlist-btn i").forEach(async e=>{let a=e.closest(".product-card")?.querySelector(".add-to-cart");if(!a)return;let s=a.dataset.id;if(isLoggedIn())try{await api.isFavorite(s)&&(e.classList.add("fas","active"),e.classList.remove("far"))}catch{}e.addEventListener("click",async()=>{if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(s)?(await api.removeFromFavorite(s),e.classList.remove("fas","active"),e.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(s),e.classList.remove("far"),e.classList.add("fas","active"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(i){showToast(i.message,"error")}})})}async function F(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(t,e);else{let r=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(r):b()}}catch(r){showToast(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function b(){window.refreshCartState&&await window.refreshCartState()}async function D(){try{let t=await api.getCategories();R(t.slice(0,4))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",t)}}function R(t){let e=document.querySelector(".categories .category-grid");!e||t.length===0||(e.innerHTML=t.map(r=>`
        <a href="category.html?id=${r.id}" class="category-card">
            <div class="category-img" style="background-image: url('${window.resolveAssetUrl?window.resolveAssetUrl(r.imagePath||"../images/placeholder.jpg"):r.imagePath||"../images/placeholder.jpg"}')"></div>
            <h3>${r.name}</h3>
        </a>
    `).join(""))}async function U(){try{let t=await api.getRecentReviews(20);j(t),H()}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043E\u0442\u0437\u044B\u0432\u043E\u0432:",t)}}function _(t){let e=(t||"").trim();if(!e)return"\u041A";let r=e.split(/\s+/).filter(Boolean);return r.length>=2?`${r[0][0]}${r[1][0]}`.toUpperCase():e.slice(0,2).toUpperCase()}function j(t){let e=document.querySelector(".testimonials .testimonial-slider");if(e){if(!Array.isArray(t)||t.length===0){e.innerHTML='<p class="loading">\u041F\u043E\u043A\u0430 \u043D\u0435\u0442 \u043E\u0442\u0437\u044B\u0432\u043E\u0432</p>';return}e.innerHTML=t.map((r,a)=>`
        <div class="testimonial-slide ${a===0?"active":""}">
            <div class="testimonial-content">
                <div class="rating">
                    ${'<i class="fas fa-star"></i>'.repeat(r.rating||5)}
                    ${'<i class="far fa-star"></i>'.repeat(Math.max(0,5-(r.rating||5)))}
                </div>
                <p class="testimonial-text">"${r.text||"\u0411\u0435\u0437 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F"}"</p>
                <div class="client-info">
                    <div class="client-photo">${_(r.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442")}</div>
                    <div class="client-details">
                        <h4>${r.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442"}</h4>
                        <p>${r.product?.name||"\u0417\u0430\u043A\u0430\u0437"}</p>
                    </div>
                </div>
            </div>
        </div>
    `).join("")}}function H(){let t=document.querySelectorAll(".testimonial-slide");if(t.length<=1)return;w&&clearInterval(w);let e=0;w=setInterval(()=>{t[e].classList.remove("active"),e=(e+1)%t.length,t[e].classList.add("active")},6e3)}document.addEventListener("DOMContentLoaded",()=>{M(),D(),U(),b(),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(e){e.preventDefault();let r=this.getAttribute("href");if(r==="#")return;let a=document.querySelector(r);a&&a.scrollIntoView({behavior:"smooth"})})})});var l=null;async function y(){let t=document.getElementById("cart-items"),e=document.getElementById("cart-empty"),r=document.getElementById("cart-summary"),a=document.getElementById("total-price"),s=document.getElementById("cart-count-sidebar");if(!t)return;if(!isLoggedIn()){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-lock" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u043E\u0439\u0434\u0438\u0442\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C
                </p>
                <a href="../other/login.html" class="btn">\u0412\u043E\u0439\u0442\u0438</a>
            </div>
        `,r.style.display="none",a&&(a.textContent="0");return}try{l=await api.getCart()}catch(n){t.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u043E\u0440\u0437\u0438\u043D\u044B: ${n.message}</p>`,e.style.display="none",r.style.display="none";return}window.applyCartState&&window.applyCartState(l);let i=l.items||[];if(s&&(s.textContent=l.totalItems||0),i.length===0){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u0438\u0437 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430, \u0447\u0442\u043E\u0431\u044B \u043E\u0444\u043E\u0440\u043C\u0438\u0442\u044C \u0437\u0430\u043A\u0430\u0437
                </p>
                <a href="../pages/catalog.html" class="btn">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433</a>
            </div>
        `,r.style.display="none",a&&(a.textContent="0");return}t.innerHTML="";let o=0;i.forEach(n=>{let d=n.totalPrice||n.price*(n.quantity||1);o+=d;let c=n.productImage||"../images/placeholder.jpg",m=window.resolveAssetUrl?window.resolveAssetUrl(c):c,u=document.createElement("div");u.className="cart-item",u.innerHTML=`
            <div class="cart-item-img" style="background-image: url('${m}')"></div>
            <div class="cart-item-info">
                <h4>${n.productName}</h4>
                <p>${n.price.toLocaleString()} \u20BD</p>
            </div>
            <div class="cart-item-quantity">
                <button class="qty-btn" onclick="changeQuantity('${n.id}', -1)">\u2212</button>
                <span>${n.quantity||1}</span>
                <button class="qty-btn" onclick="changeQuantity('${n.id}', 1)">+</button>
            </div>
            <div class="cart-item-total">
                ${d.toLocaleString()} \u20BD
            </div>
            <button class="remove-from-cart" data-item-id="${n.id}">\xD7</button>
        `,t.appendChild(u)}),a&&(a.textContent=l.totalPrice?l.totalPrice.toLocaleString():o.toLocaleString()),t.style.display="block",e.style.display="none",r.style.display="block",t.querySelectorAll(".remove-from-cart").forEach(n=>{n.addEventListener("click",async()=>{let d=n.dataset.itemId;try{l=await api.removeFromCart(d),await y(),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info")}catch(c){showToast(c.message,"error")}})})}window.changeQuantity=async function(t,e){if(!l)return;let r=l.items.find(s=>s.id==t);if(!r)return;let a=Math.max(1,(r.quantity||1)+e);try{l=await api.updateCartItem(t,a),await y(),showToast("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430","success")}catch(s){showToast(s.message,"error")}};async function J(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{let r=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),document.getElementById("cart-items")&&(l=r),window.applyCartState?window.applyCartState(r):z()}catch(r){showToast(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}function z(){window.applyCartState&&l&&window.applyCartState(l)}async function W(){if(!isLoggedIn())return JSON.parse(localStorage.getItem("favorites"))||[];try{return await api.getFavorites()}catch{return[]}}async function q(t,e,r,a,s){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u044B\u043C","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(t)?(await api.removeFromFavorite(t),s&&(s.classList.remove("fas","active"),s.classList.add("far")),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(t),s&&(s.classList.remove("far"),s.classList.add("fas","active")),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success")),document.getElementById("favorites-list")&&P()}catch(i){showToast(i.message,"error")}}async function P(){let t=document.getElementById("favorites-list"),e=document.getElementById("favorites-empty");if(!t)return;let r=await W();if(!r||r.length===0){t.style.display="none",e.style.display="block";return}t.innerHTML="",r.forEach(a=>{let s=document.createElement("div");s.className="product-card";let i=a.product?.id||a.productId,o=a.product?.name||a.name||"\u0422\u043E\u0432\u0430\u0440",n=a.product?.price||a.price||0,d=a.product?.images?.[0]?.imagePath||a.image||"../images/placeholder.jpg",c=window.resolveAssetUrl?window.resolveAssetUrl(d):d;i&&(s.dataset.id=i,s.innerHTML=`
            <div class="product-img" style="background-image: url('${c}')">
                <button class="wishlist-btn">
                    <i class="fas fa-heart active" data-id="${i}"></i>
                </button>
            </div>
            <div class="product-info">
                <h3>${o}</h3>
                <div class="product-price">
                    <span class="current-price">${n.toLocaleString()} \u20BD</span>
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${i}"
                        data-name="${o}"
                        data-price="${n}"
                        data-image="${c}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        `,t.appendChild(s),s.addEventListener("click",m=>{if(m.target.closest(".add-to-cart")||m.target.closest(".wishlist-btn"))return;let u=s.dataset.id;u&&(window.location.href=`product.html?id=${u}`)}))}),t.style.display="grid",e.style.display="none",window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState(),t.querySelectorAll(".wishlist-btn i").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.id;q(s,"",0,"",a)})})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("cart-items")&&y(),document.getElementById("favorites-list")&&P(),document.querySelectorAll(".add-to-cart").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();let{id:r}=t.dataset;window.toggleCartItem?window.toggleCartItem(r,1):J(r,1)})}),document.querySelectorAll(".wishlist-btn i").forEach(t=>{let r=t.closest(".product-card")?.querySelector(".add-to-cart");if(!r)return;let a=r.dataset.id,s=r.dataset.name,i=r.dataset.price,o=r.dataset.image;isLoggedIn()&&api.isFavorite(a).then(n=>{n&&(t.classList.remove("far"),t.classList.add("fas","active"))}).catch(()=>{}),t.addEventListener("click",()=>{q(a,s,i,o,t)})})});})();
