(()=>{function N(t){if(!t||typeof t!="string")return t;let e=t.trim();if(!e||/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e))return e;let r="http://localhost:8080";return e.startsWith("/api/")?`${r}${e}`:e.startsWith("api/")?`${r}/${e}`:e}window.resolveAssetUrl=N;window.toastConfig={default:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800},admin:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800,top:"16px",right:"16px",maxWidth:"320px",padding:"10px 14px",borderRadius:"8px",fontSize:"14px",lineHeight:"1.35"}};function _(t){let e=t?window.toastConfig.admin:window.toastConfig.default,r=window.toastOverrides&&typeof window.toastOverrides=="object"?window.toastOverrides:{};return{...e,...r}}var L="3";window.showToast=function(e,r="success"){let a=window.location.pathname.includes("/other/admin"),s=_(a),n=String(e??"").replace(/\s+/g," ").trim().slice(0,s.maxMessageLength),o=document.createElement("div");o.className=`toast-notification ${r}`,o.textContent=n||"\u0413\u043E\u0442\u043E\u0432\u043E",a&&(o.classList.add("fw-admin-toast"),o.style.position="fixed",o.style.top=s.top,o.style.right=s.right,o.style.bottom="auto",o.style.left="auto",o.style.zIndex="10000",o.style.display="inline-block",o.style.height="auto",o.style.minHeight="0",o.style.maxHeight="none",o.style.maxWidth=s.maxWidth,o.style.width="auto",o.style.padding=s.padding,o.style.borderRadius=s.borderRadius,o.style.boxSizing="border-box",o.style.boxShadow="0 6px 18px rgba(0, 0, 0, 0.2)",o.style.color="#fff",o.style.fontWeight="500",o.style.fontSize=s.fontSize,o.style.lineHeight=s.lineHeight,o.style.whiteSpace="normal",o.style.overflowWrap="anywhere",o.style.wordBreak="break-word",o.style.opacity="0",o.style.transform="translateX(120%)",o.style.transition="opacity 0.25s ease, transform 0.25s ease"),document.body.appendChild(o),setTimeout(()=>{a?(o.style.opacity="1",o.style.transform="translateX(0)"):o.classList.add("show")},s.showDelayMs),setTimeout(()=>{a?(o.style.opacity="0",o.style.transform="translateX(120%)"):o.classList.remove("show"),setTimeout(()=>o.remove(),s.removeDelayMs)},s.durationMs)};document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add("content-loaded");let t=document.getElementById("header-placeholder"),e=document.getElementById("footer-placeholder"),r=window.location.pathname.includes("/other/"),a="../",s=`fw_header_${L}`,n=`fw_footer_${L}`,o=sessionStorage.getItem(s),c=sessionStorage.getItem(n);o&&c&&(t.innerHTML=o,e.innerHTML=c),Promise.all([o?Promise.resolve(o):fetch(`${a}includes/header.html?v=${L}`).then(m=>m.text()),c?Promise.resolve(c):fetch(`${a}includes/footer.html?v=${L}`).then(m=>m.text())]).then(([m,p])=>{o||sessionStorage.setItem(s,m),c||sessionStorage.setItem(n,p),t.innerHTML=m,e.innerHTML=p;let y=document.getElementById("copyright-year");y&&(y.textContent=String(new Date().getFullYear())),D(),window.refreshCartState&&window.refreshCartState();let f=document.getElementById("hamburger"),C=document.getElementById("mobile-menu");f&&C&&f.addEventListener("click",()=>{C.classList.toggle("active")});let S=document.querySelector(".scroll-top");S&&(window.addEventListener("scroll",()=>{S.classList.toggle("visible",window.scrollY>400)}),S.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})));let I=document.getElementById("auth-btn"),i=document.getElementById("user-sidebar"),u=document.getElementById("close-user-sidebar"),l=document.getElementById("user-logout");I&&i&&I.addEventListener("click",()=>{localStorage.getItem("isLoggedIn")==="true"?i.classList.add("active"):window.location.href="../other/login.html"}),u&&i&&u.addEventListener("click",()=>{i.classList.remove("active")}),l&&l.addEventListener("click",d=>{d.preventDefault(),confirm("\u0412\u044B\u0439\u0442\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430?")&&(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("jwtToken"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),window.location.href="../pages/index.html")})}).catch(m=>console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 header/footer:",m))});document.addEventListener("click",async t=>{let e=t.target.closest(".add-to-cart");if(!e)return;let r=e.dataset.id;!r||!window.toggleCartItem||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await window.toggleCartItem(r,1))},!0);function D(){let t=localStorage.getItem("isLoggedIn")==="true",e=localStorage.getItem("userName")||"\u0413\u043E\u0441\u0442\u044C",r=localStorage.getItem("userRole")||"USER",a=document.getElementById("auth-text"),s=document.getElementById("user-display-name"),n=document.getElementById("user-avatar");a&&(a.textContent=t?e:"\u0412\u043E\u0439\u0442\u0438"),s&&(s.textContent=e);let o=document.getElementById("admin-panel-menu-item"),c=document.getElementById("desktop-admin-link"),m=document.getElementById("mobile-admin-menu-item"),p=t&&r==="ADMIN";o&&(o.style.display=p?"":"none"),c&&(c.style.display=p?"":"none"),m&&(m.style.display=p?"":"none"),n&&(r==="ADMIN"?n.src="https://randomuser.me/api/portraits/men/1.jpg":n.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=e83e8c&color=fff`)}function v(t,e){if(!t)return;let r=t.dataset.originalText||t.textContent.trim()||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443";t.dataset.originalText||(t.dataset.originalText=r),e?(t.textContent="\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0435",t.classList.add("in-cart")):(t.textContent=t.dataset.originalText||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",t.classList.remove("in-cart"))}function b(t,e){if(!t)return;let r=String(t);document.querySelectorAll(`.add-to-cart[data-id="${r}"]`).forEach(s=>{v(s,e)});let a=document.getElementById("add-to-cart-btn");a&&String(a.dataset.id)===r&&v(a,e)}function q(t){let e=document.getElementById("cart-count-sidebar");e&&(e.textContent=String(t??0))}window.applyCartState=function(e){if(!e){q(0),document.querySelectorAll(".add-to-cart").forEach(c=>v(c,!1));let o=document.getElementById("add-to-cart-btn");o&&v(o,!1);return}if(typeof e!="object"||(window.__lastCartState=e,e.totalItems!==void 0&&q(e.totalItems||0),!Array.isArray(e.items)))return;let r=e.items,a=new Set(r.map(o=>String(o.productId??""))),s=new Map(r.map(o=>[String(o.productId??""),String(o.id??"")]));window.__cartItemByProductId=s,document.querySelectorAll(".add-to-cart").forEach(o=>{let c=o.dataset.id;c&&v(o,a.has(String(c)))});let n=document.getElementById("add-to-cart-btn");n&&n.dataset.id&&v(n,a.has(String(n.dataset.id)))};window.toggleCartItem=async function(e,r=1){if(!e)return;if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}let n=(window.__cartItemByProductId||new Map).get(String(e));try{let o=null;n?(o=await window.api.removeFromCart(n),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info"),b(e,!1)):(o=await window.api.addToCart(e,r),showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),b(e,!0)),o&&window.applyCartState&&window.applyCartState(o),window.refreshCartState&&window.refreshCartState()}catch(o){showToast(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}};window.refreshCartState=async function(){if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){window.applyCartState(null);return}try{if(window.api&&typeof window.api.getCart=="function"){let a=await window.api.getCart();a&&typeof a=="object"&&window.applyCartState(a);return}let r=await fetch("http://localhost:8080/api/cart",{headers:{Authorization:`Bearer ${localStorage.getItem("jwtToken")}`}});if(r.ok){let a=await r.json();a&&typeof a=="object"&&window.applyCartState(a)}else window.applyCartState(null)}catch(r){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u043E\u0440\u0437\u0438\u043D\u044B:",r),window.applyCartState(null)}};(function(){let e=window.location.hostname;if(!(e==="localhost"||e==="127.0.0.1")||document.querySelector("script[data-livereload]"))return;let a=document.createElement("script");a.src=`http://${e}:35729/livereload.js?snipver=1`,a.async=!0,a.setAttribute("data-livereload","true"),document.body.appendChild(a)})();var A="http://localhost:8080/api",H={get token(){return localStorage.getItem("jwtToken")},set token(t){t?localStorage.setItem("jwtToken",t):localStorage.removeItem("jwtToken")},headers(){let t={"Content-Type":"application/json"};return this.token&&(t.Authorization=`Bearer ${this.token}`),t},async request(t,e={}){let r=await fetch(A+t,{...e,headers:{...this.headers(),...e.headers}});if(r.status===401)throw this.token=null,localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userRole"),window.location.href="../other/login.html",new Error("Unauthorized");if(r.status===403)throw new Error("\u0414\u043E\u0441\u0442\u0443\u043F \u0437\u0430\u043F\u0440\u0435\u0449\u0451\u043D");if(!r.ok){let s=await r.text().catch(()=>"Unknown error");throw new Error(s||r.statusText)}if(r.status===204)return null;let a=await r.text();if(!a)return null;try{return JSON.parse(a)}catch{return a}},login(t){return this.request("/auth/login",{method:"POST",body:JSON.stringify(t)})},register(t){return this.request("/auth/register",{method:"POST",body:JSON.stringify(t)})},forgotPassword(t){return this.request("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:t})})},resetPassword(t,e){return this.request("/auth/reset-password",{method:"POST",body:JSON.stringify({token:t,newPassword:e})})},getProducts(t={}){let e=new URLSearchParams(t).toString();return this.request(`/products?${e}`)},getProductBySlug(t){return this.request(`/products/${t}`)},getProductById(t){return this.request(`/products/id/${t}`)},getHits(){return this.request("/products/hits")},getNew(){return this.request("/products/new")},getCategories(){return this.request("/categories")},getCategoryBySlug(t){return this.request(`/categories/${t}`)},getCategoryById(t){return this.request(`/categories/id/${t}`)},getCart(){return this.request("/cart")},addToCart(t,e=1){return this.request("/cart/items",{method:"POST",body:JSON.stringify({productId:t,quantity:e})})},updateCartItem(t,e){return this.request(`/cart/items/${t}?quantity=${e}`,{method:"PUT"})},removeFromCart(t){return this.request(`/cart/items/${t}`,{method:"DELETE"})},clearCart(){return this.request("/cart",{method:"DELETE"})},getFavorites(){return this.request("/favorites")},addToFavorite(t){return this.request(`/favorites/${t}`,{method:"POST"})},removeFromFavorite(t){return this.request(`/favorites/${t}`,{method:"DELETE"})},isFavorite(t){return this.request(`/favorites/check/${t}`)},getMyOrders(){return this.request("/orders/my")},getOrderById(t){return this.request(`/orders/${t}`)},createOrder(t){return this.request("/orders",{method:"POST",body:JSON.stringify(t)})},getProductReviews(t){return this.request(`/reviews/product/${t}`)},getRecentReviews(t=3){return this.request(`/reviews/recent?limit=${t}`)},createReview(t,e,r){let a=localStorage.getItem("userName")||"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C";return this.request("/reviews",{method:"POST",body:JSON.stringify({productId:t,authorName:a,rating:e,text:r})})},getTestimonials(){return this.request("/content/testimonials")},getTeamMembers(){return this.request("/content/team")},getBlogPosts(t=0,e=10){return this.request(`/content/blog?page=${t}&size=${e}`)},getBlogPostBySlug(t){return this.request(`/content/blog/${t}`)},getDashboard(){return this.request("/admin/dashboard")},getAdminProducts(){return this.request("/admin/products")},getArchivedAdminProducts(){return this.request("/admin/products/archive")},createProduct(t){return this.request("/admin/products",{method:"POST",body:JSON.stringify(t)})},updateProduct(t,e){return this.request(`/admin/products/${t}`,{method:"PUT",body:JSON.stringify(e)})},updateProductPartial(t,e){return this.request(`/admin/products/${t}`,{method:"PATCH",body:JSON.stringify(e)})},uploadProductImage(t,e,r=!1){let a=new FormData;return a.append("file",e),a.append("isMain",r?"true":"false"),fetch(`${A}/products/${t}/images/upload`,{method:"POST",headers:this.token?{Authorization:`Bearer ${this.token}`}:{},body:a}).then(async s=>{if(!s.ok){let n=await s.text().catch(()=>"Upload error");throw new Error(n||s.statusText)}return s.json()})},deleteProduct(t){return this.request(`/admin/products/${t}`,{method:"DELETE"})},restoreProduct(t){return this.request(`/admin/products/${t}/restore`,{method:"POST"})},getAdminOrders(t=0,e=10){return this.request(`/admin/orders?page=${t}&size=${e}`)},getAdminOrderById(t){return this.request(`/admin/orders/${t}`)},updateOrderStatus(t,e){return this.request(`/admin/orders/${t}/status?status=${e}`,{method:"PUT"})},getAdminCategories(){return this.request("/admin/categories")},createCategory(t){return this.request("/admin/categories",{method:"POST",body:JSON.stringify(t)})},updateCategory(t,e){return this.request(`/admin/categories/${t}`,{method:"PUT",body:JSON.stringify(e)})},deleteCategory(t){return this.request(`/admin/categories/${t}`,{method:"DELETE"})},getAdminUsers(t=0,e=10){return this.request(`/admin/users?page=${t}&size=${e}`)},updateUserStatus(t,e){return this.request(`/admin/users/${t}/status?isActive=${e}`,{method:"PUT"})},deleteUser(t){return this.request(`/admin/users/${t}`,{method:"DELETE"})},getPendingReviews(t=0,e=10){return this.request(`/reviews/pending?page=${t}&size=${e}`)},approveReview(t){return this.request(`/reviews/${t}/approve`,{method:"POST"})},rejectReview(t){return this.request(`/reviews/${t}/reject`,{method:"POST"})}};window.api=H;window.isLoggedIn=function(){return localStorage.getItem("isLoggedIn")==="true"};window.isAdmin=function(){return localStorage.getItem("userRole")==="ADMIN"&&window.isLoggedIn()};window.getJwtToken=function(){return localStorage.getItem("jwtToken")};document.addEventListener("DOMContentLoaded",()=>{let t=document.querySelector(".product-grid"),e=document.querySelector(".filter-tabs"),r=document.getElementById("sort-select"),a=document.getElementById("search-input");if(!t)return;let s=[],n=[],o={romantic:["romantic","\u0440\u043E\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0435","\u0440\u043E\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0430\u044F","romance"],wedding:["wedding","\u0441\u0432\u0430\u0434\u0435\u0431\u043D\u044B\u0435","\u0441\u0432\u0430\u0434\u0435\u0431\u043D\u0430\u044F","wedding-bouquets"],spring:["spring","\u0432\u0435\u0441\u0435\u043D\u043D\u0438\u0435","\u0432\u0435\u0441\u0435\u043D\u043D\u044F\u044F"],birthday:["birthday","\u0434\u0435\u043D\u044C-\u0440\u043E\u0436\u0434\u0435\u043D\u0438\u044F","\u0434\u0435\u043D\u044C \u0440\u043E\u0436\u0434\u0435\u043D\u0438\u044F","\u043F\u0440\u0430\u0437\u0434\u043D\u0438\u0447\u043D\u044B\u0435"]};async function c(){try{t.innerHTML='<p class="text-center">\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...</p>';let i=await api.getProducts({page:0,size:200});s=i.content||i,f()}catch(i){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0442\u043E\u0432\u0430\u0440\u043E\u0432:",i),t.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438: ${i.message}</p>`}}async function m(){try{n=await api.getCategories(),p()}catch(i){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",i)}}function p(){if(!e)return;let u=['<a href="#" class="filter-tab active" data-category="all">\u0412\u0441\u0435 \u0431\u0443\u043A\u0435\u0442\u044B</a>',...[...n].sort((l,d)=>(l.sortOrder??0)-(d.sortOrder??0)).map(l=>`<a href="#" class="filter-tab" data-category="${l.id}">${l.name}</a>`)].join("");e.innerHTML=u,e.querySelectorAll(".filter-tab").forEach(l=>{l.addEventListener("click",d=>{d.preventDefault(),e.querySelectorAll(".filter-tab").forEach(g=>g.classList.remove("active")),l.classList.add("active"),f()})})}function y(i){if(t.innerHTML="",i.length===0){t.innerHTML='<p class="text-center">\u0422\u043E\u0432\u0430\u0440\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B</p>';return}i.forEach(u=>{let l=document.createElement("div");l.className="product-card",l.style.cursor="pointer";let d=u.images?.find(w=>w.isMain)?.imagePath||u.images?.[0]?.imagePath||"../images/placeholder.jpg",g=window.resolveAssetUrl?window.resolveAssetUrl(d):d;l.innerHTML=`
                <div class="product-img" style="background-image: url('${g}')">
                    ${u.oldPrice?'<span class="product-badge">\u0421\u043A\u0438\u0434\u043A\u0430</span>':""}
                    <button class="wishlist-btn"><i class="far fa-heart"></i></button>
                </div>
                <div class="product-info">
                    <h3>${u.name}</h3>
                    <p>${u.description||""}</p>
                    <div class="product-rating">
                        ${'<i class="fas fa-star"></i>'.repeat(Math.floor(u.ratingAverage||0))}
                        ${(u.ratingAverage||0)%1?'<i class="fas fa-star-half-alt"></i>':""}
                        ${'<i class="far fa-star"></i>'.repeat(5-Math.ceil(u.ratingAverage||0))}
                        <span>(${u.reviewsCount||0})</span>
                    </div>
                    <div class="product-price">
                        <span class="current-price">${u.price.toLocaleString()} \u20BD</span>
                        ${u.oldPrice?`<span class="old-price">${u.oldPrice.toLocaleString()} \u20BD</span>`:""}
                    </div>
                    <button class="btn btn-small add-to-cart"
                            data-id="${u.id}"
                            data-name="${u.name}"
                            data-price="${u.price}"
                            data-image="${g}">
                        \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                    </button>
                </div>
            `,t.appendChild(l),l.addEventListener("click",w=>{w.target.closest(".add-to-cart")||w.target.closest(".wishlist-btn")||(window.location.href=`product.html?id=${u.id}`)})}),C(),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState()}function f(){let i=[...s],u=document.querySelector(".filter-tab.active"),l=u?u.dataset.category:"all";if(l!=="all"&&(i=i.filter(d=>{if(!d.category)return!1;let g=typeof d.category=="object"?d.category.id:d.category,w=typeof d.category=="object"?d.category.name:d.category,B=typeof d.category=="object"?d.category.slug:"",k=o[l]||[l],O=String(w||"").toLowerCase(),F=String(B||"").toLowerCase();return String(g)===String(l)||k.some($=>O.includes($)||F.includes($))})),a&&a.value.trim()){let d=a.value.trim().toLowerCase();i=i.filter(g=>g.name.toLowerCase().includes(d)||g.description&&g.description.toLowerCase().includes(d)||g.composition&&g.composition.toLowerCase().includes(d))}if(r){let d=r.value;d==="price-asc"&&i.sort((g,w)=>g.price-w.price),d==="price-desc"&&i.sort((g,w)=>w.price-g.price),d==="popular"&&i.sort((g,w)=>(w.ratingAverage||0)-(g.ratingAverage||0)),d==="rating"&&i.sort((g,w)=>(w.ratingAverage||0)-(g.ratingAverage||0)),d==="new"&&(i=i.filter(g=>g.isNew))}y(i)}function C(){t.querySelectorAll(".add-to-cart").forEach(i=>{i.addEventListener("click",async u=>{u.preventDefault();let{id:l}=i.dataset;window.toggleCartItem?await window.toggleCartItem(l,1):await S(l,1)})}),t.querySelectorAll(".wishlist-btn i").forEach(async i=>{let l=i.closest(".product-card")?.querySelector(".add-to-cart");if(!l)return;let d=l.dataset.id;if(isLoggedIn())try{await api.isFavorite(d)&&(i.classList.add("fas","active"),i.classList.remove("far"))}catch{}i.addEventListener("click",async()=>{if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(d)?(await api.removeFromFavorite(d),i.classList.remove("fas","active"),i.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(d),i.classList.remove("far"),i.classList.add("fas","active"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(g){showToast(g.message,"error")}})})}async function S(i,u=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(i,u);else{let l=await api.addToCart(i,u);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(l):I()}}catch(l){showToast(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function I(){window.refreshCartState&&await window.refreshCartState()}c(),m(),I(),r&&r.addEventListener("change",f),a&&a.addEventListener("input",f)});var T=null;async function j(){try{let t=await api.getHits();R(t.slice(0,3))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043F\u0443\u043B\u044F\u0440\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432:",t)}}function R(t){let e=document.querySelector(".popular .product-grid");e&&(e.innerHTML=t.map(r=>{let a=r.images?.find(n=>n.isMain)?.imagePath||r.images?.[0]?.imagePath||"../images/placeholder.jpg",s=window.resolveAssetUrl?window.resolveAssetUrl(a):a;return`
        <div class="product-card" data-id="${r.id}">
            <div class="product-img" style="background-image: url('${s}')">
                ${r.oldPrice?'<span class="product-badge">\u0421\u043A\u0438\u0434\u043A\u0430</span>':""}
                <button class="wishlist-btn"><i class="far fa-heart"></i></button>
            </div>
            <div class="product-info">
                <h3>${r.name}</h3>
                <p>${r.description||""}</p>
                <div class="product-rating">
                    ${'<i class="fas fa-star"></i>'.repeat(Math.floor(r.ratingAverage||5))}
                    <span>(${r.reviewsCount||0})</span>
                </div>
                <div class="product-price">
                    <span class="current-price">${r.price.toLocaleString()} \u20BD</span>
                    ${r.oldPrice?`<span class="old-price">${r.oldPrice.toLocaleString()} \u20BD</span>`:""}
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${r.id}"
                        data-name="${r.name}"
                        data-price="${r.price}"
                        data-image="${s}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        </div>
    `}).join(""),U(e),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState())}function U(t){t.querySelectorAll(".product-card").forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",r=>{if(r.target.closest(".add-to-cart")||r.target.closest(".wishlist-btn"))return;let a=e.dataset.id;a&&(window.location.href=`product.html?id=${a}`)})}),t.querySelectorAll(".add-to-cart").forEach(e=>{e.addEventListener("click",async r=>{r.preventDefault();let{id:a}=e.dataset;window.toggleCartItem?await window.toggleCartItem(a,1):await z(a,1)})}),t.querySelectorAll(".wishlist-btn i").forEach(async e=>{let a=e.closest(".product-card")?.querySelector(".add-to-cart");if(!a)return;let s=a.dataset.id;if(isLoggedIn())try{await api.isFavorite(s)&&(e.classList.add("fas","active"),e.classList.remove("far"))}catch{}e.addEventListener("click",async()=>{if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(s)?(await api.removeFromFavorite(s),e.classList.remove("fas","active"),e.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(s),e.classList.remove("far"),e.classList.add("fas","active"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(n){showToast(n.message,"error")}})})}async function z(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(t,e);else{let r=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(r):P()}}catch(r){showToast(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function P(){window.refreshCartState&&await window.refreshCartState()}async function J(){try{let t=await api.getCategories();W(t.slice(0,4))}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",t)}}function W(t){let e=document.querySelector(".categories .category-grid");!e||t.length===0||(e.innerHTML=t.map(r=>`
        <a href="category.html?id=${r.id}" class="category-card">
            <div class="category-img" style="background-image: url('${window.resolveAssetUrl?window.resolveAssetUrl(r.imagePath||"../images/placeholder.jpg"):r.imagePath||"../images/placeholder.jpg"}')"></div>
            <h3>${r.name}</h3>
        </a>
    `).join(""))}async function Q(){try{let t=await api.getRecentReviews(20);X(t),Y()}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043E\u0442\u0437\u044B\u0432\u043E\u0432:",t)}}function V(t){let e=(t||"").trim();if(!e)return"\u041A";let r=e.split(/\s+/).filter(Boolean);return r.length>=2?`${r[0][0]}${r[1][0]}`.toUpperCase():e.slice(0,2).toUpperCase()}function X(t){let e=document.querySelector(".testimonials .testimonial-slider");if(e){if(!Array.isArray(t)||t.length===0){e.innerHTML='<p class="loading">\u041F\u043E\u043A\u0430 \u043D\u0435\u0442 \u043E\u0442\u0437\u044B\u0432\u043E\u0432</p>';return}e.innerHTML=t.map((r,a)=>`
        <div class="testimonial-slide ${a===0?"active":""}">
            <div class="testimonial-content">
                <div class="rating">
                    ${'<i class="fas fa-star"></i>'.repeat(r.rating||5)}
                    ${'<i class="far fa-star"></i>'.repeat(Math.max(0,5-(r.rating||5)))}
                </div>
                <p class="testimonial-text">"${r.text||"\u0411\u0435\u0437 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u044F"}"</p>
                <div class="client-info">
                    <div class="client-photo">${V(r.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442")}</div>
                    <div class="client-details">
                        <h4>${r.authorName||"\u041A\u043B\u0438\u0435\u043D\u0442"}</h4>
                        <p>${r.product?.name||"\u0417\u0430\u043A\u0430\u0437"}</p>
                    </div>
                </div>
            </div>
        </div>
    `).join("")}}function Y(){let t=document.querySelectorAll(".testimonial-slide");if(t.length<=1)return;T&&clearInterval(T);let e=0;T=setInterval(()=>{t[e].classList.remove("active"),e=(e+1)%t.length,t[e].classList.add("active")},6e3)}document.addEventListener("DOMContentLoaded",()=>{j(),J(),Q(),P(),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(e){e.preventDefault();let r=this.getAttribute("href");if(r==="#")return;let a=document.querySelector(r);a&&a.scrollIntoView({behavior:"smooth"})})})});var h=null;async function E(){let t=document.getElementById("cart-items"),e=document.getElementById("cart-empty"),r=document.getElementById("cart-summary"),a=document.getElementById("total-price"),s=document.getElementById("cart-count-sidebar");if(!t)return;if(!isLoggedIn()){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-lock" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u043E\u0439\u0434\u0438\u0442\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C
                </p>
                <a href="../other/login.html" class="btn">\u0412\u043E\u0439\u0442\u0438</a>
            </div>
        `,r.style.display="none",a&&(a.textContent="0");return}try{h=await api.getCart()}catch(c){t.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u043E\u0440\u0437\u0438\u043D\u044B: ${c.message}</p>`,e.style.display="none",r.style.display="none";return}window.applyCartState&&window.applyCartState(h);let n=h.items||[];if(s&&(s.textContent=h.totalItems||0),n.length===0){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u0438\u0437 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430, \u0447\u0442\u043E\u0431\u044B \u043E\u0444\u043E\u0440\u043C\u0438\u0442\u044C \u0437\u0430\u043A\u0430\u0437
                </p>
                <a href="../pages/catalog.html" class="btn">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433</a>
            </div>
        `,r.style.display="none",a&&(a.textContent="0");return}t.innerHTML="";let o=0;n.forEach(c=>{let m=c.totalPrice||c.price*(c.quantity||1);o+=m;let p=c.productImage||"../images/placeholder.jpg",y=window.resolveAssetUrl?window.resolveAssetUrl(p):p,f=document.createElement("div");f.className="cart-item",f.innerHTML=`
            <div class="cart-item-img" style="background-image: url('${y}')"></div>
            <div class="cart-item-info">
                <h4>${c.productName}</h4>
                <p>${c.price.toLocaleString()} \u20BD</p>
            </div>
            <div class="cart-item-quantity">
                <button class="qty-btn" onclick="changeQuantity('${c.id}', -1)">\u2212</button>
                <span>${c.quantity||1}</span>
                <button class="qty-btn" onclick="changeQuantity('${c.id}', 1)">+</button>
            </div>
            <div class="cart-item-total">
                ${m.toLocaleString()} \u20BD
            </div>
            <button class="remove-from-cart" data-item-id="${c.id}">\xD7</button>
        `,t.appendChild(f)}),a&&(a.textContent=h.totalPrice?h.totalPrice.toLocaleString():o.toLocaleString()),t.style.display="block",e.style.display="none",r.style.display="block",t.querySelectorAll(".remove-from-cart").forEach(c=>{c.addEventListener("click",async()=>{let m=c.dataset.itemId;try{h=await api.removeFromCart(m),await E(),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info")}catch(p){showToast(p.message,"error")}})})}window.changeQuantity=async function(t,e){if(!h)return;let r=h.items.find(s=>s.id==t);if(!r)return;let a=Math.max(1,(r.quantity||1)+e);try{h=await api.updateCartItem(t,a),await E(),showToast("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430","success")}catch(s){showToast(s.message,"error")}};async function K(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{let r=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),document.getElementById("cart-items")&&(h=r),window.applyCartState?window.applyCartState(r):G()}catch(r){showToast(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}function G(){window.applyCartState&&h&&window.applyCartState(h)}async function Z(){if(!isLoggedIn())return JSON.parse(localStorage.getItem("favorites"))||[];try{return await api.getFavorites()}catch{return[]}}async function x(t,e,r,a,s){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u044B\u043C","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(t)?(await api.removeFromFavorite(t),s&&(s.classList.remove("fas","active"),s.classList.add("far")),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(t),s&&(s.classList.remove("far"),s.classList.add("fas","active")),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success")),document.getElementById("favorites-list")&&M()}catch(n){showToast(n.message,"error")}}async function M(){let t=document.getElementById("favorites-list"),e=document.getElementById("favorites-empty");if(!t)return;let r=await Z();if(!r||r.length===0){t.style.display="none",e.style.display="block";return}t.innerHTML="",r.forEach(a=>{let s=document.createElement("div");s.className="product-card";let n=a.product?.id||a.productId,o=a.product?.name||a.name||"\u0422\u043E\u0432\u0430\u0440",c=a.product?.price||a.price||0,m=a.product?.images?.[0]?.imagePath||a.image||"../images/placeholder.jpg",p=window.resolveAssetUrl?window.resolveAssetUrl(m):m;n&&(s.dataset.id=n,s.innerHTML=`
            <div class="product-img" style="background-image: url('${p}')">
                <button class="wishlist-btn">
                    <i class="fas fa-heart active" data-id="${n}"></i>
                </button>
            </div>
            <div class="product-info">
                <h3>${o}</h3>
                <div class="product-price">
                    <span class="current-price">${c.toLocaleString()} \u20BD</span>
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${n}"
                        data-name="${o}"
                        data-price="${c}"
                        data-image="${p}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        `,t.appendChild(s),s.addEventListener("click",y=>{if(y.target.closest(".add-to-cart")||y.target.closest(".wishlist-btn"))return;let f=s.dataset.id;f&&(window.location.href=`product.html?id=${f}`)}))}),t.style.display="grid",e.style.display="none",window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState(),t.querySelectorAll(".wishlist-btn i").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.id;x(s,"",0,"",a)})})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("cart-items")&&E(),document.getElementById("favorites-list")&&M(),document.querySelectorAll(".add-to-cart").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();let{id:r}=t.dataset;window.toggleCartItem?window.toggleCartItem(r,1):K(r,1)})}),document.querySelectorAll(".wishlist-btn i").forEach(t=>{let r=t.closest(".product-card")?.querySelector(".add-to-cart");if(!r)return;let a=r.dataset.id,s=r.dataset.name,n=r.dataset.price,o=r.dataset.image;isLoggedIn()&&api.isFavorite(a).then(c=>{c&&(t.classList.remove("far"),t.classList.add("fas","active"))}).catch(()=>{}),t.addEventListener("click",()=>{x(a,s,n,o,t)})})});})();
