(()=>{function O(t){if(!t||typeof t!="string")return t;let e=t.trim();if(!e||/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e))return e;let o="http://localhost:8080";return e.startsWith("/api/")?`${o}${e}`:e.startsWith("api/")?`${o}/${e}`:e}window.resolveAssetUrl=O;window.toastConfig={default:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800},admin:{maxMessageLength:160,showDelayMs:50,durationMs:2800,removeDelayMs:2800,top:"16px",right:"16px",maxWidth:"320px",padding:"10px 14px",borderRadius:"8px",fontSize:"14px",lineHeight:"1.35"}};function F(t){let e=t?window.toastConfig.admin:window.toastConfig.default,o=window.toastOverrides&&typeof window.toastOverrides=="object"?window.toastOverrides:{};return{...e,...o}}var L="3";window.showToast=function(e,o="success"){let a=window.location.pathname.includes("/other/admin"),s=F(a),d=String(e??"").replace(/\s+/g," ").trim().slice(0,s.maxMessageLength),r=document.createElement("div");r.className=`toast-notification ${o}`,r.textContent=d||"\u0413\u043E\u0442\u043E\u0432\u043E",a&&(r.classList.add("fw-admin-toast"),r.style.position="fixed",r.style.top=s.top,r.style.right=s.right,r.style.bottom="auto",r.style.left="auto",r.style.zIndex="10000",r.style.display="inline-block",r.style.height="auto",r.style.minHeight="0",r.style.maxHeight="none",r.style.maxWidth=s.maxWidth,r.style.width="auto",r.style.padding=s.padding,r.style.borderRadius=s.borderRadius,r.style.boxSizing="border-box",r.style.boxShadow="0 6px 18px rgba(0, 0, 0, 0.2)",r.style.color="#fff",r.style.fontWeight="500",r.style.fontSize=s.fontSize,r.style.lineHeight=s.lineHeight,r.style.whiteSpace="normal",r.style.overflowWrap="anywhere",r.style.wordBreak="break-word",r.style.opacity="0",r.style.transform="translateX(120%)",r.style.transition="opacity 0.25s ease, transform 0.25s ease"),document.body.appendChild(r),setTimeout(()=>{a?(r.style.opacity="1",r.style.transform="translateX(0)"):r.classList.add("show")},s.showDelayMs),setTimeout(()=>{a?(r.style.opacity="0",r.style.transform="translateX(120%)"):r.classList.remove("show"),setTimeout(()=>r.remove(),s.removeDelayMs)},s.durationMs)};document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add("content-loaded");let t=document.getElementById("header-placeholder"),e=document.getElementById("footer-placeholder"),o=window.location.pathname.includes("/other/"),a="../",s=`fw_header_${L}`,d=`fw_footer_${L}`,r=sessionStorage.getItem(s),i=sessionStorage.getItem(d);r&&i&&(t.innerHTML=r,e.innerHTML=i),Promise.all([r?Promise.resolve(r):fetch(`${a}includes/header.html?v=${L}`).then(l=>l.text()),i?Promise.resolve(i):fetch(`${a}includes/footer.html?v=${L}`).then(l=>l.text())]).then(([l,m])=>{r||sessionStorage.setItem(s,l),i||sessionStorage.setItem(d,m),t.innerHTML=l,e.innerHTML=m;let f=document.getElementById("copyright-year");f&&(f.textContent=String(new Date().getFullYear())),N(),window.refreshCartState&&window.refreshCartState();let w=document.getElementById("hamburger"),n=document.getElementById("mobile-menu");w&&n&&w.addEventListener("click",()=>{n.classList.toggle("active")});let u=document.querySelector(".scroll-top");u&&(window.addEventListener("scroll",()=>{u.classList.toggle("visible",window.scrollY>400)}),u.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})));let c=document.getElementById("auth-btn"),p=document.getElementById("user-sidebar"),y=document.getElementById("close-user-sidebar"),S=document.getElementById("user-logout");c&&p&&c.addEventListener("click",()=>{localStorage.getItem("isLoggedIn")==="true"?p.classList.add("active"):window.location.href="../other/login.html"}),y&&p&&y.addEventListener("click",()=>{p.classList.remove("active")}),S&&S.addEventListener("click",I=>{I.preventDefault(),confirm("\u0412\u044B\u0439\u0442\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430?")&&(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("jwtToken"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),window.location.href="../pages/index.html")})}).catch(l=>console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 header/footer:",l))});document.addEventListener("click",async t=>{let e=t.target.closest(".add-to-cart");if(!e)return;let o=e.dataset.id;!o||!window.toggleCartItem||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await window.toggleCartItem(o,1))},!0);function N(){let t=localStorage.getItem("isLoggedIn")==="true",e=localStorage.getItem("userName")||"\u0413\u043E\u0441\u0442\u044C",o=localStorage.getItem("userRole")||"USER",a=document.getElementById("auth-text"),s=document.getElementById("user-display-name"),d=document.getElementById("user-avatar");a&&(a.textContent=t?e:"\u0412\u043E\u0439\u0442\u0438"),s&&(s.textContent=e);let r=document.getElementById("admin-panel-menu-item"),i=document.getElementById("desktop-admin-link"),l=document.getElementById("mobile-admin-menu-item"),m=t&&o==="ADMIN";r&&(r.style.display=m?"":"none"),i&&(i.style.display=m?"":"none"),l&&(l.style.display=m?"":"none"),d&&(o==="ADMIN"?d.src="https://randomuser.me/api/portraits/men/1.jpg":d.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=e83e8c&color=fff`)}function v(t,e){if(!t)return;let o=t.dataset.originalText||t.textContent.trim()||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443";t.dataset.originalText||(t.dataset.originalText=o),e?(t.textContent="\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0435",t.classList.add("in-cart")):(t.textContent=t.dataset.originalText||"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",t.classList.remove("in-cart"))}function B(t,e){if(!t)return;let o=String(t);document.querySelectorAll(`.add-to-cart[data-id="${o}"]`).forEach(s=>{v(s,e)});let a=document.getElementById("add-to-cart-btn");a&&String(a.dataset.id)===o&&v(a,e)}function q(t){let e=document.getElementById("cart-count-sidebar");e&&(e.textContent=String(t??0))}window.applyCartState=function(e){if(!e){q(0),document.querySelectorAll(".add-to-cart").forEach(i=>v(i,!1));let r=document.getElementById("add-to-cart-btn");r&&v(r,!1);return}if(typeof e!="object"||(window.__lastCartState=e,e.totalItems!==void 0&&q(e.totalItems||0),!Array.isArray(e.items)))return;let o=e.items,a=new Set(o.map(r=>String(r.productId??""))),s=new Map(o.map(r=>[String(r.productId??""),String(r.id??"")]));window.__cartItemByProductId=s,document.querySelectorAll(".add-to-cart").forEach(r=>{let i=r.dataset.id;i&&v(r,a.has(String(i)))});let d=document.getElementById("add-to-cart-btn");d&&d.dataset.id&&v(d,a.has(String(d.dataset.id)))};window.toggleCartItem=async function(e,o=1){if(!e)return;if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}let d=(window.__cartItemByProductId||new Map).get(String(e));try{let r=null;d?(r=await window.api.removeFromCart(d),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info"),B(e,!1)):(r=await window.api.addToCart(e,o),showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),B(e,!0)),r&&window.applyCartState&&window.applyCartState(r),window.refreshCartState&&window.refreshCartState()}catch(r){showToast(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}};window.refreshCartState=async function(){if(!(typeof window.isLoggedIn=="function"?window.isLoggedIn():localStorage.getItem("isLoggedIn")==="true")){window.applyCartState(null);return}try{if(window.api&&typeof window.api.getCart=="function"){let a=await window.api.getCart();a&&typeof a=="object"&&window.applyCartState(a);return}let o=await fetch("http://localhost:8080/api/cart",{headers:{Authorization:`Bearer ${localStorage.getItem("jwtToken")}`}});if(o.ok){let a=await o.json();a&&typeof a=="object"&&window.applyCartState(a)}else window.applyCartState(null)}catch(o){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u043E\u0440\u0437\u0438\u043D\u044B:",o),window.applyCartState(null)}};(function(){let e=window.location.hostname;if(!(e==="localhost"||e==="127.0.0.1")||document.querySelector("script[data-livereload]"))return;let a=document.createElement("script");a.src=`http://${e}:35729/livereload.js?snipver=1`,a.async=!0,a.setAttribute("data-livereload","true"),document.body.appendChild(a)})();var x="http://localhost:8080/api",R={get token(){return localStorage.getItem("jwtToken")},set token(t){t?localStorage.setItem("jwtToken",t):localStorage.removeItem("jwtToken")},headers(){let t={"Content-Type":"application/json"};return this.token&&(t.Authorization=`Bearer ${this.token}`),t},async request(t,e={}){let o=await fetch(x+t,{...e,headers:{...this.headers(),...e.headers}});if(o.status===401)throw this.token=null,localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userRole"),window.location.href="../other/login.html",new Error("Unauthorized");if(o.status===403)throw new Error("\u0414\u043E\u0441\u0442\u0443\u043F \u0437\u0430\u043F\u0440\u0435\u0449\u0451\u043D");if(!o.ok){let s=await o.text().catch(()=>"Unknown error");throw new Error(s||o.statusText)}if(o.status===204)return null;let a=await o.text();if(!a)return null;try{return JSON.parse(a)}catch{return a}},login(t){return this.request("/auth/login",{method:"POST",body:JSON.stringify(t)})},register(t){return this.request("/auth/register",{method:"POST",body:JSON.stringify(t)})},forgotPassword(t){return this.request("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:t})})},resetPassword(t,e){return this.request("/auth/reset-password",{method:"POST",body:JSON.stringify({token:t,newPassword:e})})},getProducts(t={}){let e=new URLSearchParams(t).toString();return this.request(`/products?${e}`)},getProductBySlug(t){return this.request(`/products/${t}`)},getProductById(t){return this.request(`/products/id/${t}`)},getHits(){return this.request("/products/hits")},getNew(){return this.request("/products/new")},getCategories(){return this.request("/categories")},getCategoryBySlug(t){return this.request(`/categories/${t}`)},getCategoryById(t){return this.request(`/categories/id/${t}`)},getCart(){return this.request("/cart")},addToCart(t,e=1){return this.request("/cart/items",{method:"POST",body:JSON.stringify({productId:t,quantity:e})})},updateCartItem(t,e){return this.request(`/cart/items/${t}?quantity=${e}`,{method:"PUT"})},removeFromCart(t){return this.request(`/cart/items/${t}`,{method:"DELETE"})},clearCart(){return this.request("/cart",{method:"DELETE"})},getFavorites(){return this.request("/favorites")},addToFavorite(t){return this.request(`/favorites/${t}`,{method:"POST"})},removeFromFavorite(t){return this.request(`/favorites/${t}`,{method:"DELETE"})},isFavorite(t){return this.request(`/favorites/check/${t}`)},getMyOrders(){return this.request("/orders/my")},getOrderById(t){return this.request(`/orders/${t}`)},createOrder(t){return this.request("/orders",{method:"POST",body:JSON.stringify(t)})},getProductReviews(t){return this.request(`/reviews/product/${t}`)},getRecentReviews(t=3){return this.request(`/reviews/recent?limit=${t}`)},createReview(t,e,o){let a=localStorage.getItem("userName")||"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C";return this.request("/reviews",{method:"POST",body:JSON.stringify({productId:t,authorName:a,rating:e,text:o})})},getTestimonials(){return this.request("/content/testimonials")},getTeamMembers(){return this.request("/content/team")},getBlogPosts(t=0,e=10){return this.request(`/content/blog?page=${t}&size=${e}`)},getBlogPostBySlug(t){return this.request(`/content/blog/${t}`)},getDashboard(){return this.request("/admin/dashboard")},getAdminProducts(){return this.request("/admin/products")},getArchivedAdminProducts(){return this.request("/admin/products/archive")},createProduct(t){return this.request("/admin/products",{method:"POST",body:JSON.stringify(t)})},updateProduct(t,e){return this.request(`/admin/products/${t}`,{method:"PUT",body:JSON.stringify(e)})},updateProductPartial(t,e){return this.request(`/admin/products/${t}`,{method:"PATCH",body:JSON.stringify(e)})},uploadProductImage(t,e,o=!1){let a=new FormData;return a.append("file",e),a.append("isMain",o?"true":"false"),fetch(`${x}/products/${t}/images/upload`,{method:"POST",headers:this.token?{Authorization:`Bearer ${this.token}`}:{},body:a}).then(async s=>{if(!s.ok){let d=await s.text().catch(()=>"Upload error");throw new Error(d||s.statusText)}return s.json()})},deleteProduct(t){return this.request(`/admin/products/${t}`,{method:"DELETE"})},restoreProduct(t){return this.request(`/admin/products/${t}/restore`,{method:"POST"})},getAdminOrders(t=0,e=10){return this.request(`/admin/orders?page=${t}&size=${e}`)},getAdminOrderById(t){return this.request(`/admin/orders/${t}`)},updateOrderStatus(t,e){return this.request(`/admin/orders/${t}/status?status=${e}`,{method:"PUT"})},getAdminCategories(){return this.request("/admin/categories")},createCategory(t){return this.request("/admin/categories",{method:"POST",body:JSON.stringify(t)})},updateCategory(t,e){return this.request(`/admin/categories/${t}`,{method:"PUT",body:JSON.stringify(e)})},deleteCategory(t){return this.request(`/admin/categories/${t}`,{method:"DELETE"})},getAdminUsers(t=0,e=10){return this.request(`/admin/users?page=${t}&size=${e}`)},updateUserStatus(t,e){return this.request(`/admin/users/${t}/status?isActive=${e}`,{method:"PUT"})},deleteUser(t){return this.request(`/admin/users/${t}`,{method:"DELETE"})},getPendingReviews(t=0,e=10){return this.request(`/reviews/pending?page=${t}&size=${e}`)},approveReview(t){return this.request(`/reviews/${t}/approve`,{method:"POST"})},rejectReview(t){return this.request(`/reviews/${t}/reject`,{method:"POST"})}};window.api=R;window.isLoggedIn=function(){return localStorage.getItem("isLoggedIn")==="true"};window.isAdmin=function(){return localStorage.getItem("userRole")==="ADMIN"&&window.isLoggedIn()};window.getJwtToken=function(){return localStorage.getItem("jwtToken")};var h=null,E=1,b=5;window.productChangeQuantity=function(t){E=Math.max(1,E+t),document.getElementById("quantity").textContent=E};window.submitReview=async function(){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u043E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u043E\u0442\u0437\u044B\u0432","error"),window.location.href="../other/login.html";return}let t=document.getElementById("review-comment").value.trim();if(!t){showToast("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u043E\u0442\u0437\u044B\u0432\u0430","error");return}try{await api.createReview(h.id,b,t),showToast("\u041E\u0442\u0437\u044B\u0432 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D \u043D\u0430 \u043C\u043E\u0434\u0435\u0440\u0430\u0446\u0438\u044E","success"),document.getElementById("review-comment").value="",loadReviews()}catch(e){showToast(e.message,"error")}};document.addEventListener("DOMContentLoaded",async()=>{let t=new URLSearchParams(window.location.search),e=t.get("id"),o=t.get("slug"),a=window.location.pathname.split("/"),s=a[a.length-1].replace(".html","");try{if(e)h=await api.getProductById(e);else if(o)h=await api.getProductBySlug(o);else if(s&&s!=="product")h=await api.getProductBySlug(s);else{showToast("\u0422\u043E\u0432\u0430\u0440 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D","error");return}d(h),f(),l()}catch(n){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0442\u043E\u0432\u0430\u0440\u0430:",n),document.getElementById("product-name").textContent="\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",document.getElementById("product-description").textContent=n.message}function d(n){document.getElementById("page-title").textContent=`${n.name} | Flowwow`,document.getElementById("breadcrumb-product").textContent=n.name,document.getElementById("product-name").textContent=n.name,document.getElementById("product-description").textContent=n.description||"",document.getElementById("product-composition").textContent=n.composition||"\u041D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D",document.getElementById("product-category").textContent=n.category?.name||"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438",document.getElementById("product-price").textContent=`${n.price.toLocaleString()} \u20BD`,n.oldPrice&&(document.getElementById("product-old-price").textContent=`${n.oldPrice.toLocaleString()} \u20BD`);let u=document.getElementById("product-rating"),c=n.ratingAverage||0,p=n.reviewsCount||0;u.innerHTML=`
            ${'<i class="fas fa-star"></i>'.repeat(Math.floor(c))}
            ${c%1?'<i class="fas fa-star-half-alt"></i>':""}
            ${'<i class="far fa-star"></i>'.repeat(5-Math.ceil(c))}
            <span>(${p} \u043E\u0442\u0437\u044B\u0432\u043E\u0432)</span>
        `;let y=n.images||[],S=y.find(C=>C.isMain)?.imagePath||y[0]?.imagePath,I=window.resolveAssetUrl?window.resolveAssetUrl(S):S;I&&(document.getElementById("main-image").style.backgroundImage=`url('${I}')`);let A=document.getElementById("thumbnail-grid");y.length>1&&(A.innerHTML=y.map((C,M)=>`
                <div class="thumbnail ${M===0?"active":""}" 
                     style="background-image: url('${window.resolveAssetUrl?window.resolveAssetUrl(C.imagePath):C.imagePath}')"
                     onclick="changeMainImage('${C.imagePath}', this)"></div>
            `).join(""));let T=document.getElementById("add-to-cart-btn");T&&(T.dataset.id=String(n.id),T.addEventListener("click",async()=>{window.toggleCartItem?await window.toggleCartItem(h.id,E):await r(h.id,E)})),window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState(),document.getElementById("favorite-btn").addEventListener("click",async()=>{await m()})}window.changeMainImage=function(n,u){let c=window.resolveAssetUrl?window.resolveAssetUrl(n):n;document.getElementById("main-image").style.backgroundImage=`url('${c}')`,document.querySelectorAll(".thumbnail").forEach(p=>p.classList.remove("active")),u.classList.add("active")};async function r(n,u=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{if(window.toggleCartItem)await window.toggleCartItem(n,u);else{let c=await api.addToCart(n,u);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),window.applyCartState?window.applyCartState(c):i()}}catch(c){showToast(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}async function i(){window.refreshCartState&&await window.refreshCartState()}async function l(){if(isLoggedIn())try{let n=await api.isFavorite(h.id),c=document.getElementById("favorite-btn").querySelector("i");n&&(c.classList.remove("far"),c.classList.add("fas"))}catch{}}async function m(){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","error"),window.location.href="../other/login.html";return}try{let n=await api.isFavorite(h.id),c=document.getElementById("favorite-btn").querySelector("i");n?(await api.removeFromFavorite(h.id),c.classList.remove("fas"),c.classList.add("far"),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(h.id),c.classList.remove("far"),c.classList.add("fas"),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success"))}catch(n){showToast(n.message,"error")}}async function f(){try{let n=await api.getProductReviews(h.id);w(n)}catch(n){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043E\u0442\u0437\u044B\u0432\u043E\u0432:",n)}}function w(n){let u=document.getElementById("reviews-list");if(!n||n.length===0){u.innerHTML="<p>\u041E\u0442\u0437\u044B\u0432\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442. \u0411\u0443\u0434\u044C\u0442\u0435 \u043F\u0435\u0440\u0432\u044B\u043C!</p>";return}u.innerHTML=n.map(c=>`
            <div class="review-card">
                <div class="review-header">
                    <strong>${c.authorName||"\u0410\u043D\u043E\u043D\u0438\u043C"}</strong>
                    <div class="review-rating">
                        ${'<i class="fas fa-star"></i>'.repeat(c.rating)}
                        ${'<i class="far fa-star"></i>'.repeat(5-c.rating)}
                    </div>
                </div>
                <p>${c.text}</p>
                <small>${new Date(c.createdAt).toLocaleDateString("ru-RU")}</small>
            </div>
        `).join("")}document.querySelectorAll("#star-rating i").forEach(n=>{n.addEventListener("click",()=>{b=parseInt(n.dataset.value),document.querySelectorAll("#star-rating i").forEach((u,c)=>{u.classList.toggle("active",c<b)})})})});var g=null;async function $(){let t=document.getElementById("cart-items"),e=document.getElementById("cart-empty"),o=document.getElementById("cart-summary"),a=document.getElementById("total-price"),s=document.getElementById("cart-count-sidebar");if(!t)return;if(!isLoggedIn()){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-lock" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u043E\u0439\u0434\u0438\u0442\u0435 \u0434\u043B\u044F \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u044B</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0442\u043E\u043B\u044C\u043A\u043E \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C
                </p>
                <a href="../other/login.html" class="btn">\u0412\u043E\u0439\u0442\u0438</a>
            </div>
        `,o.style.display="none",a&&(a.textContent="0");return}try{g=await api.getCart()}catch(i){t.innerHTML=`<p class="error">\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u043E\u0440\u0437\u0438\u043D\u044B: ${i.message}</p>`,e.style.display="none",o.style.display="none";return}window.applyCartState&&window.applyCartState(g);let d=g.items||[];if(s&&(s.textContent=g.totalItems||0),d.length===0){t.style.display="none",e.style.display="block",e.innerHTML=`
            <div style="padding: 80px 20px; text-align: center;">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
                <h2>\u0412\u0430\u0448\u0430 \u043A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430</h2>
                <p style="margin: 15px 0 30px; color: #666;">
                    \u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u0438\u0437 \u043A\u0430\u0442\u0430\u043B\u043E\u0433\u0430, \u0447\u0442\u043E\u0431\u044B \u043E\u0444\u043E\u0440\u043C\u0438\u0442\u044C \u0437\u0430\u043A\u0430\u0437
                </p>
                <a href="../pages/catalog.html" class="btn">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u0432 \u043A\u0430\u0442\u0430\u043B\u043E\u0433</a>
            </div>
        `,o.style.display="none",a&&(a.textContent="0");return}t.innerHTML="";let r=0;d.forEach(i=>{let l=i.totalPrice||i.price*(i.quantity||1);r+=l;let m=i.productImage||"../images/placeholder.jpg",f=window.resolveAssetUrl?window.resolveAssetUrl(m):m,w=document.createElement("div");w.className="cart-item",w.innerHTML=`
            <div class="cart-item-img" style="background-image: url('${f}')"></div>
            <div class="cart-item-info">
                <h4>${i.productName}</h4>
                <p>${i.price.toLocaleString()} \u20BD</p>
            </div>
            <div class="cart-item-quantity">
                <button class="qty-btn" onclick="changeQuantity('${i.id}', -1)">\u2212</button>
                <span>${i.quantity||1}</span>
                <button class="qty-btn" onclick="changeQuantity('${i.id}', 1)">+</button>
            </div>
            <div class="cart-item-total">
                ${l.toLocaleString()} \u20BD
            </div>
            <button class="remove-from-cart" data-item-id="${i.id}">\xD7</button>
        `,t.appendChild(w)}),a&&(a.textContent=g.totalPrice?g.totalPrice.toLocaleString():r.toLocaleString()),t.style.display="block",e.style.display="none",o.style.display="block",t.querySelectorAll(".remove-from-cart").forEach(i=>{i.addEventListener("click",async()=>{let l=i.dataset.itemId;try{g=await api.removeFromCart(l),await $(),showToast("\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B","info")}catch(m){showToast(m.message,"error")}})})}window.changeQuantity=async function(t,e){if(!g)return;let o=g.items.find(s=>s.id==t);if(!o)return;let a=Math.max(1,(o.quantity||1)+e);try{g=await api.updateCartItem(t,a),await $(),showToast("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430","success")}catch(s){showToast(s.message,"error")}};async function U(t,e=1){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error"),window.location.href="../other/login.html";return}try{let o=await api.addToCart(t,e);showToast("\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","success"),document.getElementById("cart-items")&&(g=o),window.applyCartState?window.applyCartState(o):D()}catch(o){showToast(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443","error")}}function D(){window.applyCartState&&g&&window.applyCartState(g)}async function j(){if(!isLoggedIn())return JSON.parse(localStorage.getItem("favorites"))||[];try{return await api.getFavorites()}catch{return[]}}async function P(t,e,o,a,s){if(!isLoggedIn()){showToast("\u0412\u043E\u0439\u0434\u0438\u0442\u0435, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u044B\u043C","error"),window.location.href="../other/login.html";return}try{await api.isFavorite(t)?(await api.removeFromFavorite(t),s&&(s.classList.remove("fas","active"),s.classList.add("far")),showToast("\u0423\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E","info")):(await api.addToFavorite(t),s&&(s.classList.remove("far"),s.classList.add("fas","active")),showToast("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435","success")),document.getElementById("favorites-list")&&k()}catch(d){showToast(d.message,"error")}}async function k(){let t=document.getElementById("favorites-list"),e=document.getElementById("favorites-empty");if(!t)return;let o=await j();if(!o||o.length===0){t.style.display="none",e.style.display="block";return}t.innerHTML="",o.forEach(a=>{let s=document.createElement("div");s.className="product-card";let d=a.product?.id||a.productId,r=a.product?.name||a.name||"\u0422\u043E\u0432\u0430\u0440",i=a.product?.price||a.price||0,l=a.product?.images?.[0]?.imagePath||a.image||"../images/placeholder.jpg",m=window.resolveAssetUrl?window.resolveAssetUrl(l):l;d&&(s.dataset.id=d,s.innerHTML=`
            <div class="product-img" style="background-image: url('${m}')">
                <button class="wishlist-btn">
                    <i class="fas fa-heart active" data-id="${d}"></i>
                </button>
            </div>
            <div class="product-info">
                <h3>${r}</h3>
                <div class="product-price">
                    <span class="current-price">${i.toLocaleString()} \u20BD</span>
                </div>
                <button class="btn btn-small add-to-cart"
                        data-id="${d}"
                        data-name="${r}"
                        data-price="${i}"
                        data-image="${m}">
                    \u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443
                </button>
            </div>
        `,t.appendChild(s),s.addEventListener("click",f=>{if(f.target.closest(".add-to-cart")||f.target.closest(".wishlist-btn"))return;let w=s.dataset.id;w&&(window.location.href=`product.html?id=${w}`)}))}),t.style.display="grid",e.style.display="none",window.applyCartState&&window.__lastCartState?window.applyCartState(window.__lastCartState):window.refreshCartState&&window.refreshCartState(),t.querySelectorAll(".wishlist-btn i").forEach(a=>{a.addEventListener("click",()=>{let s=a.dataset.id;P(s,"",0,"",a)})})}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("cart-items")&&$(),document.getElementById("favorites-list")&&k(),document.querySelectorAll(".add-to-cart").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();let{id:o}=t.dataset;window.toggleCartItem?window.toggleCartItem(o,1):U(o,1)})}),document.querySelectorAll(".wishlist-btn i").forEach(t=>{let o=t.closest(".product-card")?.querySelector(".add-to-cart");if(!o)return;let a=o.dataset.id,s=o.dataset.name,d=o.dataset.price,r=o.dataset.image;isLoggedIn()&&api.isFavorite(a).then(i=>{i&&(t.classList.remove("far"),t.classList.add("fas","active"))}).catch(()=>{}),t.addEventListener("click",()=>{P(a,s,d,r,t)})})});})();
